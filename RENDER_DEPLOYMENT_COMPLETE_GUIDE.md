# Complete Render Deployment Guide
## MSU-SND ROTC Grading Management System

This guide provides step-by-step instructions for deploying the complete Django backend system to Render with all four services.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Prerequisites](#prerequisites)
3. [Service Configuration](#service-configuration)
4. [Deployment Steps](#deployment-steps)
5. [Post-Deployment Verification](#post-deployment-verification)
6. [Monitoring and Maintenance](#monitoring-and-maintenance)
7. [Troubleshooting](#troubleshooting)
8. [Rollback Procedure](#rollback-procedure)

---

## Architecture Overview

The system consists of four Django services deployed on Render:

1. **rotc-django-web** (Web Service)
   - Gunicorn WSGI server
   - Handles REST API requests
   - Port: Dynamically assigned by Render ($PORT)
   - Health check: `/api/health/`

2. **rotc-django-channels** (Web Service)
   - Daphne ASGI server
   - Handles WebSocket connections
   - Port: Dynamically assigned by Render ($PORT)
   - Endpoints: `/ws/notifications/`, `/ws/chat/{room_id}/`, `/ws/updates/`

3. **rotc-celery-worker** (Worker Service)
   - Background task processing
   - Handles async operations (emails, reports, file processing)
   - Concurrency: 2 workers

4. **rotc-celery-beat** (Worker Service)
   - Periodic task scheduler
   - Runs scheduled tasks (cleanup, reports, backups)

### External Services

- **PostgreSQL Database** (NeonDB or Render PostgreSQL)
- **Redis** (Upstash or Render Redis)
- **Cloudinary** (Media storage)
- **Sentry** (Error tracking - optional)

---

## Prerequisites

### 1. Render Account Setup

- Create a Render account at https://render.com
- Add payment method (required for Starter plan services)
- Connect your GitHub repository

### 2. External Services Setup

#### PostgreSQL Database (NeonDB Recommended)

1. Create account at https://neon.tech
2. Create a new project
3. Create a database named `rotc_db`
4. Copy the connection string (starts with `postgresql://`)
5. Note: NeonDB offers serverless PostgreSQL with auto-scaling

**Alternative: Render PostgreSQL**
- Create PostgreSQL database in Render dashboard
- Plan: Starter ($7/month)
- Region: Oregon (same as services)

#### Redis (Upstash Recommended)

1. Create account at https://upstash.com
2. Create a new Redis database
3. Select region closest to Oregon
4. Copy the connection string (starts with `redis://`)
5. Note: Upstash offers serverless Redis with persistent storage

**Alternative: Render Redis**
- Create Redis instance in Render dashboard
- Plan: Starter ($7/month)
- Region: Oregon (same as services)

#### Cloudinary (Media Storage)

1. Create account at https://cloudinary.com
2. Go to Dashboard
3. Copy:
   - Cloud Name
   - API Key
   - API Secret
4. Free tier: 25GB storage, 25GB bandwidth

#### Sentry (Error Tracking - Optional)

1. Create account at https://sentry.io
2. Create a new project (Django)
3. Copy the DSN (Data Source Name)
4. Free tier: 5K errors/month

---

## Service Configuration

### Environment Variables

All services require these environment variables. Configure them in Render dashboard:

#### Core Django Settings

```bash
DJANGO_ENV=production
DJANGO_SETTINGS_MODULE=config.settings.production
DJANGO_SECRET_KEY=<auto-generated-by-render>
DEBUG=False
```

#### Database Configuration

```bash
DATABASE_URL=<from-neondb-or-render-postgresql>
```

#### Redis Configuration

```bash
REDIS_URL=<from-upstash-or-render-redis>
```

#### Service-Specific Settings

**rotc-django-web:**
```bash
ALLOWED_HOSTS=rotc-django-web.onrender.com,msu-snd-rgms-1.onrender.com,localhost,127.0.0.1
CORS_ALLOWED_ORIGINS=https://msu-snd-rgms-1.onrender.com,https://rotc-django-web.onrender.com
GUNICORN_WORKERS=4
GUNICORN_LOG_LEVEL=info
```

**rotc-django-channels:**
```bash
ALLOWED_HOSTS=rotc-django-channels.onrender.com,localhost,127.0.0.1
DAPHNE_VERBOSITY=1
```

**rotc-celery-worker & rotc-celery-beat:**
```bash
CLOUDINARY_CLOUD_NAME=<your-cloud-name>
CLOUDINARY_API_KEY=<your-api-key>
CLOUDINARY_API_SECRET=<your-api-secret>
SENTRY_DSN=<your-sentry-dsn>  # Optional
```

---

## Deployment Steps

### Step 1: Prepare Repository

1. Ensure `render.yaml` is in the repository root
2. Commit and push all changes to GitHub
3. Verify `rotc_backend/requirements.txt` is up to date

### Step 2: Create Render Blueprint

1. Go to Render Dashboard
2. Click "New" â†’ "Blueprint"
3. Connect your GitHub repository
4. Select the repository containing `render.yaml`
5. Render will automatically detect the blueprint

### Step 3: Configure Environment Variables

For each service, configure the environment variables in Render dashboard:

1. Go to service settings
2. Navigate to "Environment" tab
3. Add all required environment variables
4. Use "Add from .env" to bulk import if needed

**Critical Variables to Configure:**

- `DATABASE_URL` - From NeonDB or Render PostgreSQL
- `REDIS_URL` - From Upstash or Render Redis
- `CLOUDINARY_CLOUD_NAME` - From Cloudinary dashboard
- `CLOUDINARY_API_KEY` - From Cloudinary dashboard
- `CLOUDINARY_API_SECRET` - From Cloudinary dashboard
- `ALLOWED_HOSTS` - Include your Render service domains
- `CORS_ALLOWED_ORIGINS` - Include your frontend domain

### Step 4: Deploy Services

Render will automatically deploy all services defined in `render.yaml`:

1. **rotc-django-web** deploys first
   - Runs migrations
   - Collects static files
   - Starts Gunicorn server
   - Health check at `/api/health/`

2. **rotc-django-channels** deploys
   - Starts Daphne server
   - Connects to Redis channel layer

3. **rotc-celery-worker** deploys
   - Connects to Redis broker
   - Starts consuming tasks

4. **rotc-celery-beat** deploys
   - Connects to Redis broker
   - Starts scheduling periodic tasks

### Step 5: Verify Deployment

Check each service status in Render dashboard:

- All services should show "Live" status
- Check logs for any errors
- Verify health check passes for web service

---

## Post-Deployment Verification

### 1. Health Check Verification

```bash
curl https://rotc-django-web.onrender.com/api/health/
```

Expected response:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00Z",
  "services": {
    "database": "connected",
    "redis": "connected",
    "celery": "running"
  },
  "version": "1.0.0",
  "environment": "production"
}
```

### 2. API Endpoint Verification

Test authentication endpoint:
```bash
curl -X POST https://rotc-django-web.onrender.com/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "your-password"}'
```

### 3. WebSocket Connection Verification

Use a WebSocket client to test:
```javascript
const ws = new WebSocket('wss://rotc-django-channels.onrender.com/ws/notifications/?token=<jwt-token>');

ws.onopen = () => console.log('Connected');
ws.onmessage = (event) => console.log('Message:', event.data);
ws.onerror = (error) => console.error('Error:', error);
```

### 4. Celery Task Verification

Check Celery worker logs in Render dashboard:
- Look for "celery@worker ready"
- Verify tasks are being consumed

Check Celery beat logs:
- Look for "Scheduler: Sending due task"
- Verify scheduled tasks are running

### 5. Database Migration Verification

```bash
# SSH into web service (if available) or check logs
python manage.py showmigrations
```

All migrations should show `[X]` indicating they're applied.

---

## Monitoring and Maintenance

### Service Monitoring

1. **Render Dashboard**
   - Monitor service status (Live/Deploying/Failed)
   - Check CPU and memory usage
   - Review deployment logs

2. **Health Checks**
   - Web service health check runs every 30 seconds
   - Automatic restart if health check fails 3 times

3. **Sentry Error Tracking** (if configured)
   - Monitor error rates
   - Track performance metrics
   - Set up alerts for critical errors

### Performance Metrics

Monitor these key metrics:

- **Response Time**: 95th percentile < 500ms for read operations
- **Error Rate**: < 1% under normal load
- **Cache Hit Rate**: > 80% for frequently accessed data
- **Database Query Time**: < 100ms for simple queries
- **Celery Task Queue Length**: < 100 pending tasks

### Log Monitoring

Check logs regularly for:
- Error messages
- Slow queries
- Failed tasks
- Connection issues
- Security warnings

### Scheduled Maintenance Tasks

Celery Beat runs these tasks automatically:

- **Daily 2 AM UTC**: Cleanup old sessions
- **Daily 3 AM UTC**: Cleanup expired tokens
- **Daily 6 AM UTC**: Generate daily reports
- **Every 15 minutes**: Sync attendance data
- **Weekly Sunday 4 AM UTC**: Database backup

---

## Troubleshooting

### Service Won't Start

**Symptom**: Service shows "Deploy failed" or keeps restarting

**Solutions**:
1. Check build logs for errors
2. Verify all environment variables are set
3. Check `DATABASE_URL` and `REDIS_URL` are correct
4. Ensure port binding is `0.0.0.0:$PORT`
5. Verify Python version is 3.11

### Health Check Failing

**Symptom**: Service shows "Unhealthy" status

**Solutions**:
1. Check `/api/health/` endpoint manually
2. Verify database connection
3. Verify Redis connection
4. Check Celery worker is running
5. Review application logs for errors

### Database Connection Errors

**Symptom**: "OperationalError: could not connect to server"

**Solutions**:
1. Verify `DATABASE_URL` is correct
2. Check database service is running
3. Verify SSL mode is configured
4. Check firewall rules allow connection
5. Test connection with `psql` command

### Redis Connection Errors

**Symptom**: "ConnectionError: Error connecting to Redis"

**Solutions**:
1. Verify `REDIS_URL` is correct
2. Check Redis service is running
3. Verify Redis credentials
4. Check Redis memory usage (free tier has 25MB limit)
5. Test connection with `redis-cli`

### WebSocket Connection Fails

**Symptom**: WebSocket connections immediately close

**Solutions**:
1. Verify JWT token is valid
2. Check Channels service is running
3. Verify Redis channel layer is configured
4. Check CORS settings allow WebSocket connections
5. Test with WebSocket client tool

### Celery Tasks Not Processing

**Symptom**: Tasks queue up but don't execute

**Solutions**:
1. Check Celery worker logs
2. Verify Redis broker connection
3. Check task queue length
4. Verify worker concurrency setting
5. Restart Celery worker service

### Static Files Not Loading

**Symptom**: 404 errors for static files

**Solutions**:
1. Run `python manage.py collectstatic`
2. Verify WhiteNoise is configured
3. Check `STATIC_ROOT` setting
4. Verify `STATICFILES_STORAGE` setting
5. Check file permissions

### CORS Errors

**Symptom**: "Access-Control-Allow-Origin" errors in browser

**Solutions**:
1. Verify `CORS_ALLOWED_ORIGINS` includes frontend domain
2. Check `CORS_ALLOW_CREDENTIALS` is True
3. Verify `corsheaders` middleware is installed
4. Check frontend is using correct API URL
5. Test with curl to isolate issue

---

## Rollback Procedure

If deployment fails or issues arise, follow this rollback procedure:

### When to Rollback

Trigger rollback if:
- Error rate > 5%
- Response time > 1 second (95th percentile)
- Critical functionality broken
- Data integrity issues

### Rollback Steps

1. **Stop Django Services**
   ```bash
   # In Render dashboard, suspend all Django services:
   # - rotc-django-web
   # - rotc-django-channels
   # - rotc-celery-worker
   # - rotc-celery-beat
   ```

2. **Restore Database from Backup**
   ```bash
   # If using NeonDB, restore from point-in-time recovery
   # If using Render PostgreSQL, restore from backup
   
   # Or use backup script:
   cd rotc_backend/scripts
   python rollback_migration.py
   ```

3. **Redeploy Previous Version**
   ```bash
   # In Render dashboard:
   # 1. Go to each service
   # 2. Click "Manual Deploy"
   # 3. Select previous successful deployment
   # 4. Click "Deploy"
   ```

4. **Verify Rollback**
   ```bash
   # Check health endpoint
   curl https://rotc-django-web.onrender.com/api/health/
   
   # Run smoke tests
   cd rotc_backend
   python -m pytest tests/smoke_tests.py
   ```

5. **Update Frontend Configuration** (if needed)
   ```bash
   # Revert frontend API URLs to previous backend
   # Update .env.production in frontend repository
   ```

### Rollback Completion Criteria

- All services show "Live" status
- Health checks pass
- Smoke tests pass (100% success rate)
- No errors in logs
- Response times normal

### Post-Rollback Actions

1. Document the issue that caused rollback
2. Investigate root cause
3. Fix issues in development environment
4. Test thoroughly before re-deployment
5. Update deployment checklist if needed

---

## Deployment Checklist

Use this checklist before each deployment:

### Pre-Deployment

- [ ] All code changes committed and pushed to GitHub
- [ ] All tests pass locally
- [ ] Database migrations created and tested
- [ ] Environment variables documented
- [ ] `render.yaml` updated with correct configuration
- [ ] `requirements.txt` updated with all dependencies
- [ ] Static files collected locally
- [ ] Backup of production database created

### Deployment

- [ ] All environment variables configured in Render
- [ ] Database service is running
- [ ] Redis service is running
- [ ] Cloudinary credentials configured
- [ ] All four services deployed successfully
- [ ] Health checks passing
- [ ] No errors in deployment logs

### Post-Deployment

- [ ] Health endpoint returns 200 OK
- [ ] API endpoints responding correctly
- [ ] WebSocket connections working
- [ ] Celery tasks processing
- [ ] Celery beat scheduling tasks
- [ ] Static files loading correctly
- [ ] Frontend can connect to backend
- [ ] Integration tests pass (>95% success rate)
- [ ] Performance metrics acceptable
- [ ] Error tracking configured (Sentry)
- [ ] Monitoring alerts configured

### 24-Hour Monitoring

- [ ] Error rate < 1%
- [ ] Response time < 500ms (95th percentile)
- [ ] No critical errors in Sentry
- [ ] Database performance normal
- [ ] Redis memory usage normal
- [ ] Celery queue length normal
- [ ] No user-reported issues

---

## Cost Estimation

### Render Services (Starter Plan)

- **rotc-django-web**: $7/month
- **rotc-django-channels**: $7/month
- **rotc-celery-worker**: $7/month
- **rotc-celery-beat**: $7/month
- **PostgreSQL** (if using Render): $7/month
- **Redis** (if using Render): $7/month

**Total (all Render services)**: $42/month

### External Services (Recommended)

- **NeonDB PostgreSQL**: Free tier (up to 3 projects)
- **Upstash Redis**: Free tier (10K commands/day)
- **Cloudinary**: Free tier (25GB storage, 25GB bandwidth)
- **Sentry**: Free tier (5K errors/month)

**Total (with external services)**: $28/month

---

## Support and Resources

### Documentation

- Django: https://docs.djangoproject.com/
- Django REST Framework: https://www.django-rest-framework.org/
- Celery: https://docs.celeryproject.org/
- Channels: https://channels.readthedocs.io/
- Render: https://render.com/docs

### Community

- Django Forum: https://forum.djangoproject.com/
- Stack Overflow: https://stackoverflow.com/questions/tagged/django
- Render Community: https://community.render.com/

### Internal Documentation

- `API_ENDPOINTS.md` - API endpoint documentation
- `CELERY_IMPLEMENTATION.md` - Celery task documentation
- `WEBSOCKET_IMPLEMENTATION.md` - WebSocket documentation
- `DEPLOYMENT_GUIDE.md` - Original deployment guide
- `RENDER_NEONDB_SETUP.md` - NeonDB setup guide

---

## Conclusion

This guide provides comprehensive instructions for deploying the MSU-SND ROTC Grading Management System to Render with all four Django services. Follow the steps carefully, verify each stage, and monitor the system after deployment.

For issues or questions, refer to the troubleshooting section or consult the internal documentation.

**Last Updated**: 2024-01-15
**Version**: 1.0.0
