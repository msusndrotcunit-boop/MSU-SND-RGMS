# Render Deployment Guide - MSU-SND RGMS

## Overview
This guide provides step-by-step instructions for deploying the MSU-SND ROTC Grading Management System to Render.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Render Services                           │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────┐      ┌──────────────────┐            │
│  │  Django Backend  │◄────►│   PostgreSQL DB  │            │
│  │  (Python 3.11)   │      │   (Free Tier)    │            │
│  └────────┬─────────┘      └──────────────────┘            │
│           │                                                  │
│           │                 ┌──────────────────┐            │
│           └────────────────►│   Redis Cache    │            │
│                             │   (Free Tier)    │            │
│                             └──────────────────┘            │
│                                                               │
│  Frontend: Served as static files from Django                │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## Prerequisites

1. **Render Account**: Sign up at https://render.com
2. **GitHub Repository**: Code must be in a GitHub repository
3. **Cloudinary Account**: For media file storage (optional but recommended)

## Environment Variables

### Required Environment Variables

| Variable | Description | Example Value |
|----------|-------------|---------------|
| `DJANGO_SECRET_KEY` | Django secret key for cryptographic signing | Auto-generated by Render |
| `DATABASE_URL` | PostgreSQL connection string | Auto-populated by Render |
| `REDIS_URL` | Redis connection string | Auto-populated by Render |
| `DJANGO_SETTINGS_MODULE` | Django settings module | `config.settings.production` |
| `PYTHON_VERSION` | Python runtime version | `3.11.0` |

### Optional Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `DEBUG` | Enable debug mode | `False` |
| `ALLOWED_HOSTS` | Comma-separated list of allowed hosts | `*` |
| `CORS_ALLOWED_ORIGINS` | Comma-separated list of CORS origins | Backend URL |
| `CLOUDINARY_CLOUD_NAME` | Cloudinary cloud name | - |
| `CLOUDINARY_API_KEY` | Cloudinary API key | - |
| `CLOUDINARY_API_SECRET` | Cloudinary API secret | - |
| `SENTRY_DSN` | Sentry error tracking DSN | - |

## Deployment Steps

### Step 1: Prepare Repository

1. Ensure all changes are committed:
   ```bash
   git add -A
   git commit -m "Prepare for Render deployment"
   git push origin main
   ```

2. Verify files exist:
   - `render.yaml` (root directory)
   - `rotc_backend/runtime.txt`
   - `rotc_backend/build.sh`
   - `rotc_backend/requirements.txt`

### Step 2: Create Render Services

#### Option A: Using render.yaml (Recommended)

1. Go to Render Dashboard: https://dashboard.render.com
2. Click "New" → "Blueprint"
3. Connect your GitHub repository
4. Render will automatically detect `render.yaml` and create all services

#### Option B: Manual Setup

##### 1. Create PostgreSQL Database

1. Click "New" → "PostgreSQL"
2. Name: `msu-snd-rgms-db`
3. Database: `rotc_db`
4. User: `rotc_user`
5. Region: Oregon (or closest to your users)
6. Plan: Free
7. Click "Create Database"
8. **Save the Internal Database URL** (you'll need this)

##### 2. Create Redis Instance

1. Click "New" → "Redis"
2. Name: `msu-snd-rgms-redis`
3. Region: Oregon
4. Plan: Free
5. Maxmemory Policy: `noeviction`
6. Click "Create Redis"
7. **Save the Internal Redis URL**

##### 3. Create Web Service (Django Backend)

1. Click "New" → "Web Service"
2. Connect your GitHub repository
3. Configure:
   - **Name**: `msu-snd-rgms-backend`
   - **Region**: Oregon
   - **Branch**: `main`
   - **Root Directory**: Leave empty
   - **Runtime**: Python 3
   - **Build Command**:
     ```bash
     cd rotc_backend && chmod +x build.sh && ./build.sh
     ```
   - **Start Command**:
     ```bash
     cd rotc_backend && daphne -b 0.0.0.0 -p $PORT config.asgi:application
     ```
   - **Plan**: Free

4. Add Environment Variables:
   - Click "Advanced" → "Add Environment Variable"
   - Add all required variables from the table above
   - For `DATABASE_URL`: Use the Internal Database URL from Step 1
   - For `REDIS_URL`: Use the Internal Redis URL from Step 2

5. Click "Create Web Service"

### Step 3: Configure Environment Variables

1. Go to your web service dashboard
2. Click "Environment" tab
3. Verify all required variables are set:

```env
DJANGO_SECRET_KEY=<auto-generated>
DATABASE_URL=<from-database>
REDIS_URL=<from-redis>
DJANGO_SETTINGS_MODULE=config.settings.production
PYTHON_VERSION=3.11.0
DEBUG=False
ALLOWED_HOSTS=msu-snd-rgms-1.onrender.com,localhost,127.0.0.1
CORS_ALLOWED_ORIGINS=https://msu-snd-rgms-1.onrender.com
```

4. Add Cloudinary variables (if using):
```env
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret
```

### Step 4: Build Frontend

The frontend is built and served as static files from Django.

1. **Local Build** (before deployment):
   ```bash
   cd client
   npm ci
   npm run build
   cp -r dist ../rotc_backend/frontend_build
   cd ..
   git add rotc_backend/frontend_build
   git commit -m "Add frontend build"
   git push origin main
   ```

2. **Automatic Build** (on deployment):
   - The `build.sh` script runs `collectstatic`
   - Django serves frontend from `frontend_build/` directory
   - WhiteNoise handles static file serving

### Step 5: Verify Deployment

1. **Check Build Logs**:
   - Go to your web service
   - Click "Logs" tab
   - Verify build completed successfully
   - Look for "Build Complete!" message

2. **Check Service Status**:
   - Service should show "Live" status
   - Health check should be passing

3. **Test Endpoints**:
   ```bash
   # Health check
   curl https://your-service.onrender.com/api/health/
   
   # JWT diagnostic
   curl https://your-service.onrender.com/api/jwt-diagnostic
   
   # Admin creation
   curl https://your-service.onrender.com/api/emergency-admin
   ```

4. **Test Frontend**:
   - Visit: `https://your-service.onrender.com`
   - Should load the React application
   - Try logging in as admin

### Step 6: Post-Deployment Tasks

1. **Create Admin Account**:
   ```bash
   curl https://your-service.onrender.com/api/emergency-admin
   ```

2. **Run Verification Script**:
   ```bash
   python rotc_backend/scripts/verify_jwt_deployment.py https://your-service.onrender.com
   ```

3. **Test Login**:
   - Go to your application URL
   - Login with admin credentials
   - Verify dashboard loads correctly

4. **Remove Emergency Endpoints** (after successful login):
   - Delete `rotc_backend/apps/system/emergency_admin.py`
   - Remove route from `rotc_backend/apps/system/urls.py`
   - Commit and push

## Troubleshooting

### Build Failures

**Issue**: Build fails with "Module not found"
**Solution**: 
- Check `requirements.txt` has all dependencies
- Verify Python version in `runtime.txt`
- Check build logs for specific error

**Issue**: Static files not collected
**Solution**:
- Verify `STATIC_ROOT` in settings
- Check `collectstatic` command in build script
- Ensure `whitenoise` is installed

### Runtime Errors

**Issue**: "Application failed to respond"
**Solution**:
- Check start command is correct
- Verify `$PORT` environment variable is used
- Check application logs for errors

**Issue**: Database connection errors
**Solution**:
- Verify `DATABASE_URL` is set correctly
- Check database is in same region as web service
- Ensure database is not paused (free tier limitation)

**Issue**: Redis connection errors
**Solution**:
- Verify `REDIS_URL` is set correctly
- Check Redis instance is running
- Ensure Redis is in same region

### Authentication Issues

**Issue**: "Token signature is invalid"
**Solution**:
- Check `DJANGO_SECRET_KEY` is set
- Verify JWT configuration in settings
- Run JWT diagnostic endpoint
- See `JWT_TROUBLESHOOTING_GUIDE.md`

**Issue**: CORS errors
**Solution**:
- Add frontend URL to `CORS_ALLOWED_ORIGINS`
- Verify `django-cors-headers` is installed
- Check CORS middleware is in `MIDDLEWARE` list

## Monitoring

### Health Checks

Render automatically monitors:
- HTTP health check at `/api/health/`
- Response time
- Error rate

### Logs

Access logs:
1. Go to service dashboard
2. Click "Logs" tab
3. Filter by:
   - Time range
   - Log level (INFO, WARNING, ERROR)
   - Search term

### Metrics

Monitor:
- Request rate
- Response time
- Error rate
- Memory usage
- CPU usage

## Scaling

### Free Tier Limitations

- **Web Service**: Spins down after 15 minutes of inactivity
- **Database**: 90-day expiration, 1GB storage
- **Redis**: 25MB storage

### Upgrading

To handle more traffic:
1. Upgrade to Starter plan ($7/month)
2. Benefits:
   - No spin down
   - More resources
   - Better performance
   - Longer database retention

## Backup and Recovery

### Database Backups

1. **Manual Backup**:
   ```bash
   # From Render dashboard
   # Database → Backups → Create Backup
   ```

2. **Automated Backups** (Paid plans only):
   - Daily automatic backups
   - Point-in-time recovery

### Restore from Backup

1. Go to Database dashboard
2. Click "Backups" tab
3. Select backup
4. Click "Restore"

## Security Best Practices

1. **Environment Variables**:
   - Never commit secrets to Git
   - Use Render's environment variable management
   - Rotate secrets periodically

2. **HTTPS**:
   - Render provides free SSL certificates
   - Always use HTTPS in production
   - Set `SECURE_SSL_REDIRECT=True`

3. **Database**:
   - Use strong passwords
   - Restrict database access
   - Regular backups

4. **Monitoring**:
   - Enable error tracking (Sentry)
   - Monitor logs regularly
   - Set up alerts for errors

## Maintenance

### Regular Tasks

1. **Weekly**:
   - Check logs for errors
   - Monitor performance metrics
   - Review security alerts

2. **Monthly**:
   - Update dependencies
   - Review and rotate secrets
   - Check database size

3. **Quarterly**:
   - Security audit
   - Performance optimization
   - Backup verification

### Updating Dependencies

1. Update `requirements.txt`:
   ```bash
   pip list --outdated
   pip install --upgrade <package>
   pip freeze > requirements.txt
   ```

2. Test locally:
   ```bash
   python manage.py test
   ```

3. Deploy:
   ```bash
   git add requirements.txt
   git commit -m "Update dependencies"
   git push origin main
   ```

## Support

### Resources

- **Render Documentation**: https://render.com/docs
- **Django Documentation**: https://docs.djangoproject.com
- **Project Documentation**: See `JWT_TROUBLESHOOTING_GUIDE.md`

### Getting Help

1. Check logs first
2. Review troubleshooting guides
3. Search Render community forum
4. Contact Render support (paid plans)

## Checklist

### Pre-Deployment
- [ ] All code committed and pushed
- [ ] `render.yaml` configured
- [ ] `runtime.txt` specifies Python 3.11
- [ ] `build.sh` is executable
- [ ] Frontend built and copied to backend
- [ ] Environment variables documented

### Deployment
- [ ] PostgreSQL database created
- [ ] Redis instance created
- [ ] Web service created
- [ ] Environment variables set
- [ ] Build completed successfully
- [ ] Service is live

### Post-Deployment
- [ ] Health check passing
- [ ] Admin account created
- [ ] Login tested successfully
- [ ] JWT validation working
- [ ] Static files serving correctly
- [ ] Emergency endpoints removed

### Monitoring
- [ ] Logs reviewed
- [ ] Error tracking configured
- [ ] Performance metrics monitored
- [ ] Backup strategy in place

---

**Last Updated**: 2026-02-27  
**Version**: 1.0.0  
**Maintainer**: MSU-SND ROTC IT Team
