import{u as e,j as t}from"./index-Df_F6O4f.js";import{r as s}from"./vendor-react-BJYbxeCs.js";import{a}from"./vendor-utils-qHW_S61q.js";import{aD as r,a as l,aP as n,T as i,X as o,az as c}from"./vendor-ui-Cf-65S3f.js";const d=()=>{const{user:d}=e(),[x,m]=s.useState([]),[g,u]=s.useState(null),[h,f]=s.useState(""),[p,b]=s.useState(!0),[y,j]=s.useState(!1),[v,w]=s.useState(null),N=s.useRef(null),S=async()=>{try{const e=await a.get("/api/staff/chat/messages");m(e.data||[])}catch(e){}finally{b(!1)}};s.useEffect(()=>{(async()=>{try{const e=await a.get("/api/staff/me");u(e.data)}catch(e){}})(),S();const e=setInterval(S,3e3);return()=>clearInterval(e)},[]),s.useEffect(()=>{if(N.current&&(N.current.scrollTop=N.current.scrollHeight),x.length>0){const e=x[x.length-1],t=parseInt(localStorage.getItem("lastSeenMessageId")||"0");e.id>t&&localStorage.setItem("lastSeenMessageId",e.id.toString())}},[x]);const k=e=>[e.rank,e.last_name,e.first_name].filter(Boolean).join(" ")||"Staff";return t.jsxs("div",{className:"flex flex-col h-[calc(100vh-4rem)] md:h-[calc(100vh-5rem)] bg-gray-50",children:[t.jsxs("div",{className:"bg-white border-b p-3 flex items-center gap-2 shadow-sm shrink-0",children:[t.jsx(r,{className:"text-green-700",size:24}),t.jsx("h2",{className:"text-lg font-bold text-gray-800",children:"Staff Chat"})]}),t.jsx("div",{ref:N,className:"flex-1 overflow-y-auto p-4 space-y-4",children:p?t.jsx("div",{className:"text-center text-gray-500 py-10",children:"Loading conversation..."}):0===x.length?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400 space-y-2",children:[t.jsx(r,{size:48,className:"opacity-20"}),t.jsx("p",{children:"No messages yet. Say hello!"})]}):x.map(e=>{const s=g&&e.staff_id===g.id,r=(o=e.profile_pic)?o.startsWith("http")?o:`https://msu-snd-rgms-1.onrender.com${o}`:null;var o;return t.jsxs("div",{className:"flex items-end gap-2 group "+(s?"flex-row-reverse":"flex-row"),children:[t.jsxs("div",{className:"flex-shrink-0 mb-1",children:[r?t.jsx("img",{src:r,alt:"Avatar",className:"w-8 h-8 rounded-full object-cover border border-gray-200",onError:e=>{e.target.onerror=null,e.target.style.display="none",e.target.nextSibling.style.display="flex"}}):null,t.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 border border-gray-300 "+(r?"hidden":"flex"),children:t.jsx(l,{size:14})})]}),t.jsxs("div",{className:"max-w-[75%] md:max-w-[60%] px-4 py-2 rounded-2xl shadow-sm text-sm "+(s?"bg-green-600 text-white rounded-br-none":"bg-white text-gray-800 border border-gray-100 rounded-bl-none"),children:[!s&&t.jsx("div",{className:"text-xs font-bold text-green-700 mb-1",children:k(e)}),t.jsx("div",{className:"whitespace-pre-wrap break-words leading-relaxed",children:e.content}),t.jsx("div",{className:"text-[10px] mt-1 text-right "+(s?"text-green-100":"text-gray-400"),children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),s&&t.jsxs("div",{className:"opacity-0 group-hover:opacity-100 flex flex-col gap-1 transition-opacity self-center mb-2",children:[t.jsx("button",{onClick:()=>{return w(t=e),void f(t.content);var t},className:"p-1.5 text-gray-400 hover:text-blue-500 bg-gray-100 hover:bg-blue-50 rounded-full shadow-sm",title:"Edit",children:t.jsx(n,{size:12})}),t.jsx("button",{onClick:()=>(async e=>{if(confirm("Delete this message?"))try{await a.delete(`/api/staff/chat/messages/${e}`),await S()}catch(t){}})(e.id),className:"p-1.5 text-gray-400 hover:text-red-500 bg-gray-100 hover:bg-red-50 rounded-full shadow-sm",title:"Delete",children:t.jsx(i,{size:12})})]})]},e.id)})}),t.jsxs("div",{className:"bg-white p-3 border-t shrink-0",children:[v&&t.jsxs("div",{className:"flex items-center justify-between bg-blue-50 px-4 py-2 text-xs text-blue-600 mb-2 rounded-lg border border-blue-100",children:[t.jsx("span",{children:"Editing message..."}),t.jsx("button",{onClick:()=>{w(null),f("")},className:"text-blue-400 hover:text-blue-700",children:t.jsx(o,{size:14})})]}),t.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),h.trim()){j(!0);try{v?(await a.put(`/api/staff/chat/messages/${v.id}`,{content:h.trim()}),w(null)):await a.post("/api/staff/chat/messages",{content:h.trim()}),f(""),await S()}catch(t){}finally{j(!1)}}},className:"flex items-center gap-2 max-w-4xl mx-auto",children:[t.jsx("input",{type:"text",value:h,onChange:e=>f(e.target.value),placeholder:"Type a message...",className:"flex-1 bg-gray-100 text-gray-800 rounded-full px-5 py-3 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all"}),t.jsx("button",{type:"submit",disabled:y||!h.trim(),className:"p-3 rounded-full flex-shrink-0 transition-colors "+(y||!h.trim()?"bg-gray-200 text-gray-400 cursor-default":"bg-green-600 text-white hover:bg-green-700 shadow-md"),children:t.jsx(c,{size:20,className:y?"animate-pulse":""})})]})]})]})};export{d as default};
