import{j as e,g as a,c as t}from"./index-b5aGx8Xb.js";import{r as s,b as r,L as l}from"./vendor-react-BJYbxeCs.js";import{a as o}from"./vendor-utils-qHW_S61q.js";import{W as d}from"./WeatherAdvisory-CS4_JXSc.js";import{v as i,N as n,O as c,Q as m,R as x,V as g,W as h,Y as p,Z as b,_ as u,$ as y,a0 as j,a1 as v,a2 as f,a3 as N,C as w,a4 as _,o as E,t as D}from"./vendor-ui-Cf-65S3f.js";const I=({children:a,className:t=""})=>{const r=s.useRef(null),l=s.useRef(!0);return s.useEffect(()=>(l.current=!0,()=>{if(l.current=!1,r.current){r.current.querySelectorAll("canvas").forEach(e=>{try{e.width=0,e.height=0,e.parentNode&&e.parentNode.removeChild(e)}catch{}})}}),[]),e.jsx("div",{ref:r,className:t,children:a})},S=()=>{const[l,S]=s.useState({ongoing:0,completed:0,incomplete:0,failed:0,drop:0}),[F,L]=s.useState([]),[M,R]=s.useState([]),[A,T]=s.useState(!0),[$,P]=s.useState([]),[z,U]=s.useState(()=>{try{return!("undefined"==typeof window||"true"===localStorage.getItem("rgms_hide_admin_map"))}catch{return!1}}),V="undefined"!=typeof window?(localStorage.getItem("role")||"").toLowerCase():"admin";s.useEffect(()=>{const e=async()=>{try{const e=await a("analytics","dashboard_v2");e&&e.timestamp&&Date.now()-e.timestamp<3e5&&(Q(e.data),T(!1));const s=await o.get("/api/admin/analytics");Q(s.data),await t("analytics","dashboard_v2",{data:s.data,timestamp:Date.now()}),T(!1)}catch(e){T(!1)}};let s;e();const r=()=>{try{s=new EventSource("/api/attendance/events"),s.onmessage=a=>{try{const t=JSON.parse(a.data||"{}");new Set(["cadet_updated","cadet_created","cadet_deleted","cadet_profile_updated","attendance_updated","grade_updated","staff_attendance_updated"]).has(t.type)&&(e(),"admin"===V&&z&&"location_update"===t.type&&G())}catch{}},s.onerror=()=>{try{s&&s.close()}catch{}setTimeout(r,3e3)}}catch{}};return r(),()=>{try{s&&s.close()}catch{}}},[]);const G=r.useCallback(async()=>{try{const e=await o.get("/api/admin/locations");P(e.data||[])}catch(e){}},[]);s.useEffect(()=>{const e=e=>{var a;try{const t=!0===(null==(a=null==e?void 0:e.detail)?void 0:a.hide);U(!t)}catch{}};return window.addEventListener("rgms:hide_admin_map",e),()=>window.removeEventListener("rgms:hide_admin_map",e)},[]),s.useEffect(()=>{if("admin"!==V||!z)return;G();const e=setInterval(G,6e4);return()=>clearInterval(e)},[V,z,G]);const Q=e=>{const a=e&&e.demographics&&e.demographics.courseStats||e&&e.demographics&&e.demographics.academicCourseStats||[],t={Ongoing:0,Completed:0,Incomplete:0,Failed:0,Drop:0},s={},r=new Set(["COQC","MS1","MS2","MS31","MS32","MS41","MS42"]),l={};a.forEach(e=>{const a=K(e.status),o=(e=>{const a=(e||"").toUpperCase().replace(/\s+/g,"").replace(/[-_.]/g,"");return r.has(a)?a:null})(e.cadet_course||e.course||""),d=Number(e.count)||0;void 0!==t[a]&&(t[a]+=d),o&&(s[o]||(s[o]={name:o,total:0}),s[o].total+=d,l[o]||(l[o]={name:o,Ongoing:0,Completed:0,Incomplete:0,Failed:0,Drop:0}),void 0!==l[o][a]&&(l[o][a]+=d))}),S({ongoing:t.Ongoing,completed:t.Completed,incomplete:t.Incomplete,failed:t.Failed,drop:t.Drop});const o=Object.values(s).sort((e,a)=>a.total-e.total).slice(0,10);L(o);const d=["COQC","MS1","MS2","MS31","MS32","MS41","MS42"].map(e=>({name:e,...l[e]||{name:e,Ongoing:0,Completed:0,Incomplete:0,Failed:0,Drop:0}}));R(d)},K=e=>{if(!e)return"Unknown";const a=e.toUpperCase();return["ONGOING","ENROLLED","ACTIVE"].includes(a)?"Ongoing":["COMPLETED","GRADUATED","PASSED"].includes(a)?"Completed":["INC","INCOMPLETE","T","DO"].includes(a)?"Incomplete":["FAILED","FAIL"].includes(a)?"Failed":["DROP","DROPPED"].includes(a)?"Drop":"Ongoing"};return e.jsxs("div",{className:"space-y-8 p-2",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-gray-100 flex items-center",children:e.jsx("span",{className:"border-l-4 border-[var(--primary-color)] pl-3",children:"ROTC Unit Dashboard"})})}),e.jsx(d,{}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsx(O,{title:"ONGOING (VERIFIED)",count:l.ongoing,color:"text-cyan-500",icon:e.jsx(i,{className:"h-10 w-10 text-cyan-500 mb-2"})}),e.jsx(O,{title:"COMPLETED (VERIFIED)",count:l.completed,color:"text-green-500",icon:e.jsx(n,{className:"h-10 w-10 text-green-500 mb-2"})}),e.jsx(O,{title:"INCOMPLETE (VERIFIED)",count:l.incomplete,color:"text-amber-500",icon:e.jsx(c,{className:"h-10 w-10 text-amber-500 mb-2"})}),e.jsx(O,{title:"FAILED (VERIFIED)",count:l.failed,color:"text-red-500",icon:e.jsx(m,{className:"h-10 w-10 text-red-500 mb-2"})}),e.jsx(O,{title:"DROP (VERIFIED)",count:l.drop,color:"text-gray-500",icon:e.jsx(x,{className:"h-10 w-10 text-gray-500 mb-2"})})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 border-t-4 border-[var(--primary-color)]",children:[e.jsx("div",{className:"flex items-center mb-4",children:e.jsx("h3",{className:"font-bold text-gray-800 dark:text-gray-100",children:"Cadet Status Distribution by Course (Verified Only)"})}),e.jsx(I,{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsxs(h,{data:F,children:[e.jsx(p,{strokeDasharray:"3 3",vertical:!1}),e.jsx(b,{dataKey:"name"}),e.jsx(u,{allowDecimals:!1}),e.jsx(y,{}),e.jsx(j,{}),e.jsx(v,{dataKey:"total",fill:"#2563eb"})]})})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:M.map(a=>e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-md p-4 border-t-4 border-[var(--primary-color)]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-bold text-gray-800 dark:text-gray-100",children:a.name}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Total: ",a.Ongoing+a.Completed+a.Incomplete+a.Failed+a.Drop||0]})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-2",children:[e.jsx(k,{label:"Ongoing",value:a.Ongoing,color:"text-cyan-600"}),e.jsx(k,{label:"Completed",value:a.Completed,color:"text-green-600"}),e.jsx(k,{label:"Incomplete",value:a.Incomplete,color:"text-amber-600"}),e.jsx(k,{label:"Failed",value:a.Failed,color:"text-red-600"}),e.jsx(k,{label:"Drop",value:a.Drop,color:"text-gray-600"})]})]},a.name))}),"admin"===V&&z&&$.length>0&&e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 border-t-4 border-[var(--primary-color)]",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(f,{className:"text-[var(--primary-color)] mr-2",size:20}),e.jsx("h3",{className:"font-bold text-gray-800 dark:text-gray-100",children:"Live User Locations"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left font-semibold text-gray-600 dark:text-gray-300",children:"User"}),e.jsx("th",{className:"px-4 py-2 text-left font-semibold text-gray-600 dark:text-gray-300",children:"Role"}),e.jsx("th",{className:"px-4 py-2 text-left font-semibold text-gray-600 dark:text-gray-300",children:"Location"}),e.jsx("th",{className:"px-4 py-2 text-left font-semibold text-gray-600 dark:text-gray-300",children:"Last Updated"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:$.map(a=>{const t="cadet"===a.role?`${a.cadet_last_name||""}, ${a.cadet_first_name||""}`.trim():"training_staff"===a.role?`${a.staff_rank||""} ${a.staff_last_name||""}`.trim():a.username,s=`https://www.google.com/maps?q=${a.last_latitude},${a.last_longitude}`,r=a.last_location_at?new Date(a.last_location_at).toLocaleString():"";return e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-gray-800 dark:text-gray-100",children:t||a.username}),e.jsx("td",{className:"px-4 py-2 capitalize text-gray-600 dark:text-gray-300",children:a.role}),e.jsx("td",{className:"px-4 py-2",children:e.jsxs("a",{href:s,target:"_blank",rel:"noreferrer",className:"text-[var(--primary-color)] hover:underline",children:[a.last_latitude.toFixed(4),", ",a.last_longitude.toFixed(4)]})}),e.jsx("td",{className:"px-4 py-2 text-gray-500 dark:text-gray-400",children:r})]},a.id)})})]})})]}),e.jsxs("div",{className:"bg-gradient-to-r from-green-900 to-green-800 rounded-lg p-6 text-white shadow-lg border border-green-700",children:[e.jsxs("div",{className:"flex items-center mb-4 border-b border-green-600 pb-2",children:[e.jsx(N,{className:"text-yellow-400 mr-2",size:20}),e.jsx("h3",{className:"font-bold text-yellow-50",children:"Quick Actions"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsx(C,{to:"/admin/data-analysis",label:"Data Analysis",icon:e.jsx(i,{size:18}),className:"bg-white/10 hover:bg-white/20 border border-white/20 backdrop-blur-sm transition-all duration-200"}),e.jsx(C,{to:"/admin/grading",label:"Grading",icon:e.jsx(w,{size:18}),className:"bg-white/10 hover:bg-white/20 border border-white/20 backdrop-blur-sm transition-all duration-200"}),e.jsx(C,{to:"/admin/attendance",label:"Attendance",icon:e.jsx(_,{size:18}),className:"bg-white/10 hover:bg-white/20 border border-white/20 backdrop-blur-sm transition-all duration-200"}),e.jsx(C,{to:"/admin/messages",label:"Messages",icon:e.jsx(E,{size:18}),className:"bg-white/10 hover:bg-white/20 border border-white/20 backdrop-blur-sm transition-all duration-200"}),e.jsx(C,{to:"/admin/activities",label:"Activities",icon:e.jsx(D,{size:18}),className:"bg-yellow-500 hover:bg-yellow-400 text-green-900 font-bold shadow-lg border-2 border-yellow-300"})]})]})]})},O=({title:a,count:t,color:s,icon:r})=>e.jsx("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-md p-4 border-t-4 border-[var(--primary-color)]",children:e.jsxs("div",{className:"flex flex-col items-center",children:[r,e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:a}),e.jsx("div",{className:`text-2xl font-bold ${s}`,children:t||0})]})}),C=({to:a,label:t,icon:s,className:r})=>e.jsxs(l,{to:a,className:`flex items-center justify-center px-4 py-2 rounded ${r}`,children:[e.jsx("span",{className:"mr-2",children:s}),e.jsx("span",{className:"text-xs md:text-sm",children:t})]}),k=({label:a,value:t,color:s})=>e.jsxs("div",{className:"rounded bg-gray-50 dark:bg-gray-800 p-2 text-center",children:[e.jsx("div",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:a}),e.jsx("div",{className:`text-lg font-bold ${s}`,children:t||0})]});export{S as default};
