import{g as e,c as t,j as a}from"./index-b5aGx8Xb.js";import{u as s,r}from"./vendor-react-BJYbxeCs.js";import{a as l}from"./vendor-utils-qHW_S61q.js";import{E as d}from"./ExcuseLetterManager-Cv2nPGQe.js";import{t as i,al as n,X as c,ag as o,a7 as x,N as m,ab as g,T as u,z as p,D as h,n as f,Q as y,am as b,O as j}from"./vendor-ui-Cf-65S3f.js";import"./ResponsiveTable-C00et9LP.js";import"./useResponsive-XC39aU2L.js";const v=()=>{s();const[v,N]=r.useState("attendance"),[w,k]=r.useState("cadet"),[C,_]=r.useState([]),[S,$]=r.useState(null),[I,D]=r.useState([]),[R,z]=r.useState(!0),[L,O]=r.useState(!1),[T,E]=r.useState({date:"",title:"",description:""}),[A,P]=r.useState(!1),[F,M]=r.useState([]),U=r.useRef(null),B=r.useRef(null),[V,Z]=r.useState(!1),[H,q]=r.useState(!1),[G,J]=r.useState(null),[Q,K]=r.useState(!1),W=r.useRef(null),[X,Y]=r.useState(""),[ee,te]=r.useState(""),[ae,se]=r.useState(""),[re,le]=r.useState(!0),[de,ie]=r.useState(!1),[ne,ce]=r.useState([]),[oe,xe]=r.useState(!1),[me,ge]=r.useState([]),[ue,pe]=r.useState(null),[he,fe]=r.useState(new Set),[ye,be]=r.useState("skip-duplicates");r.useEffect(()=>{je()},[]),r.useEffect(()=>{S&&ve(S)},[w]);const je=async(a=!1)=>{try{if(!a)try{const t=await e("admin","training_days");if(t){let e=t,a=0;if(t.data&&t.timestamp?(e=t.data,a=t.timestamp):Array.isArray(t)&&(e=t),Array.isArray(e)&&e.length>0&&(_(e),z(!1),a&&Date.now()-a<12e4))return}}catch{}const s=await l.get("/api/attendance/days");_(s.data),await t("admin","training_days",{data:s.data,timestamp:Date.now()}),z(!1)}catch(s){z(!1)}},ve=async(a,s=!1)=>{$(a),z(!0);try{const r=`${a.id}_${w}`;if(!s)try{const t=await e("attendance_by_day",r);if(t){let e=t,a=0;if(t.data&&t.timestamp?(e=t.data,a=t.timestamp):Array.isArray(t)&&(e=t),Array.isArray(e)&&(D(e),a&&Date.now()-a<1e4))return void z(!1)}}catch{}const d="cadet"===w?`/api/attendance/records/${a.id}`:`/api/attendance/records/staff/${a.id}`,i=await l.get(d);D(i.data),await t("attendance_by_day",r,{data:i.data,timestamp:Date.now()}),z(!1)}catch(r){z(!1)}},Ne=async()=>{try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});U.current&&(U.current.srcObject=e,Z(!0),J(null),M([]))}catch(e){f.error("Failed to access camera. Please check permissions.")}},we=()=>{U.current&&U.current.srcObject&&(U.current.srcObject.getTracks().forEach(e=>e.stop()),Z(!1))};r.useEffect(()=>(A||we(),()=>we()),[A]);const ke=e=>{const t=e.split("\n"),a=[],s=/(\d{1,2}:\d{2}\s*[APap][Mm]?)/g;I.forEach(e=>{const r=e.last_name.replace(/[^a-zA-Z0-9]/g,""),l=e.first_name.split(" ")[0].replace(/[^a-zA-Z0-9]/g,""),d=new RegExp(`${r}`,"i"),i=t.filter(e=>d.test(e));let n=null;for(const t of i){if(t.toLowerCase().includes(l.toLowerCase())){n=t;break}if(e.rank&&t.toLowerCase().includes(e.rank.toLowerCase())){n=t;break}}if(n){let t="present";const r=n.toLowerCase();r.includes("absent")?t="absent":r.includes("excused")?t="excused":r.includes("late")&&(t="late");const l=n.match(s)||[],d=l[0]||"",i=l[1]||"";let c=null;if(e.cadet_course){const t=e.cadet_course.replace(/[^a-zA-Z0-9]/g,"");if(t.length>0){new RegExp(`\\b${t}\\b`,"i").test(n.replace(/[^a-zA-Z0-9\s]/g,""))&&(c=e.cadet_course)}}a.push({id:"cadet"===w?e.cadet_id:e.staff_id,name:`${e.last_name}, ${e.first_name}`,rank:e.rank,detectedStatus:t,timeIn:d,timeOut:i,detectedCourse:c,recordCourse:e.cadet_course,originalRecord:e})}});const r=Array.from(new Map(a.map(e=>[e.id,e])).values());M(r),q(!1),0===r.length?f.error("No matching names found in scan. Ensure the image is clear and contains names from the list."):f.success(`Found ${r.length} records! Review before confirming.`)},Ce=async(e,a)=>{const s=I.find(t=>"cadet"===w?t.cadet_id===e:t.staff_id===e),r=(null==s?void 0:s.remarks)||"",d=(null==s?void 0:s.time_in)||"",i=(null==s?void 0:s.time_out)||"",n=I.map(t=>("cadet"===w?t.cadet_id===e:t.staff_id===e)?{...t,status:a}:t);if(D(n),S){const e=`${S.id}_${w}`;t("attendance_by_day",e,{data:n,timestamp:Date.now()}).catch(console.error)}try{const s={dayId:S.id,["cadet"===w?"cadetId":"staffId"]:e,status:a,remarks:r,time_in:d,time_out:i},n="cadet"===w?"/api/attendance/mark":"/api/attendance/mark/staff";await l.post(n,s),"cadet"===w&&(await t("grading","cadets_list",null),await t("admin","cadets_list",null))}catch(c){}},_e=(e,a,s)=>{const r=I.map(t=>("cadet"===w?t.cadet_id===e:t.staff_id===e)?{...t,[a]:s}:t);if(D(r),S){const e=`${S.id}_${w}`;t("attendance_by_day",e,{data:r,timestamp:Date.now()}).catch(console.error)}},Se=async(e,a,s)=>{try{const r=I.find(t=>"cadet"===w?t.cadet_id===e:t.staff_id===e),d={dayId:S.id,["cadet"===w?"cadetId":"staffId"]:e,status:(null==r?void 0:r.status)||"present",remarks:(null==r?void 0:r.remarks)||"",time_in:"time_in"===a?s:(null==r?void 0:r.time_in)||"",time_out:"time_out"===a?s:(null==r?void 0:r.time_out)||""},i="cadet"===w?"/api/attendance/mark":"/api/attendance/mark/staff";await l.post(i,d),"cadet"===w&&(await t("grading","cadets_list",null),await t("admin","cadets_list",null))}catch(r){}},$e=I.filter(e=>{if("cadet"===w){const t=!X||e.company===X,a=!ee||e.platoon===ee,s=!ae||`${e.last_name} ${e.first_name}`.toLowerCase().includes(ae.toLowerCase());return t&&a&&s}return!ae||`${e.last_name} ${e.first_name}`.toLowerCase().includes(ae.toLowerCase())}),Ie=I.reduce((e,t)=>{const a=t.status||"unmarked";return e[a]=(e[a]||0)+1,e},{});return a.jsxs("div",{className:"h-full flex flex-col gap-4",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-center bg-white dark:bg-gray-900 p-4 rounded shadow gap-4",children:[a.jsx("h1",{className:"text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-100",children:"Attendance & Excuses"}),a.jsxs("div",{className:"flex flex-col w-full sm:w-auto sm:flex-row gap-2",children:[a.jsxs("button",{onClick:()=>N("attendance"),className:"flex-1 sm:flex-none justify-center px-3 md:px-4 py-2 rounded flex items-center transition text-sm md:text-base "+("attendance"===v?"bg-[var(--primary-color)] text-white":"bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"),children:[a.jsx(i,{size:18,className:"mr-2"}),a.jsx("span",{className:"whitespace-nowrap",children:"Training Days"})]}),a.jsxs("button",{onClick:()=>N("excuse"),className:"flex-1 sm:flex-none justify-center px-3 md:px-4 py-2 rounded flex items-center transition text-sm md:text-base "+("excuse"===v?"bg-[var(--primary-color)] text-white":"bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"),children:[a.jsx(n,{size:18,className:"mr-2"}),a.jsx("span",{className:"whitespace-nowrap",children:"Excuse Letters"})]})]})]}),A&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-0 md:p-4 backdrop-blur-sm",children:a.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-xl w-full max-w-5xl h-full md:h-[90vh] flex flex-col md:flex-row overflow-hidden relative",children:[a.jsx("button",{onClick:()=>P(!1),className:"absolute top-4 right-4 z-50 text-white bg-black bg-opacity-50 p-2 rounded-full hover:bg-opacity-80",children:a.jsx(c,{size:24})}),a.jsxs("div",{className:"w-full md:w-1/2 bg-black flex flex-col relative h-[60vh] md:h-auto md:flex-1",children:[a.jsxs("div",{className:"flex-1 relative overflow-hidden flex items-center justify-center",children:[a.jsx("video",{ref:U,autoPlay:!0,playsInline:!0,muted:!0,className:"absolute inset-0 w-full h-full object-cover "+(G?"hidden":"")}),a.jsx("canvas",{ref:B,className:"hidden"}),G&&a.jsx("img",{src:G,alt:"Scan",className:"absolute inset-0 w-full h-full object-contain"}),!V&&!G&&a.jsxs("div",{className:"text-white text-center",children:[a.jsx(o,{size:48,className:"mx-auto mb-2 opacity-50"}),a.jsx("p",{children:"Camera is inactive"})]})]}),a.jsxs("div",{className:"p-4 bg-gray-900 flex justify-center gap-4",children:[V?a.jsxs("button",{onClick:async()=>{if(U.current&&B.current){q(!0);try{const e=U.current,t=B.current;t.width=e.videoWidth,t.height=e.videoHeight;t.getContext("2d").drawImage(e,0,0,t.width,t.height);const a=t.toDataURL("image/png");if(J(a),we(),!window.Tesseract)throw new Error("OCR Library not loaded. Check internet connection.");const{data:{text:s}}=await window.Tesseract.recognize(a,"eng");ke(s)}catch(e){f.error(e.message||"OCR Failed"),q(!1)}}},disabled:H,className:"bg-[var(--primary-color)] text-white px-6 py-2 rounded-full flex items-center gap-2 disabled:opacity-50 hover:opacity-90",children:[H?a.jsx(x,{className:"animate-spin",size:20}):a.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-pulse"}),H?"Processing...":"Capture & Scan"]}):a.jsxs("button",{onClick:Ne,className:"bg-[var(--primary-color)] text-white px-6 py-2 rounded-full flex items-center gap-2 hover:opacity-90",children:[a.jsx(o,{size:20})," Start Camera"]}),G&&a.jsx("button",{onClick:()=>{J(null),M([]),Ne()},className:"bg-gray-600 text-white px-4 py-2 rounded-full",children:"Retake"})]})]}),a.jsxs("div",{className:"w-full md:w-1/2 bg-gray-50 dark:bg-gray-950 flex flex-col h-[40vh] md:h-auto md:flex-1",children:[a.jsxs("div",{className:"p-4 border-b bg-white dark:bg-gray-900 dark:border-gray-800",children:[a.jsx("h3",{className:"font-bold text-lg text-gray-800 dark:text-gray-100",children:"Scan Results"}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:F.length>0?`Found ${F.length} records matching current list.`:"Capture an attendance sheet to detect names."})]}),a.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:0===F.length?a.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400 dark:text-gray-500",children:[a.jsx(n,{size:48,className:"mb-2 opacity-20"}),a.jsx("p",{children:"No records detected yet"})]}):F.map((e,t)=>a.jsxs("div",{className:"bg-white p-3 rounded shadow-sm border flex flex-col gap-2",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsx("div",{className:"font-bold text-gray-800",children:e.name}),a.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-2",children:[a.jsx("span",{children:e.rank}),e.recordCourse&&a.jsx("span",{className:"px-1 rounded "+(e.detectedCourse?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:e.detectedCourse?e.detectedCourse:`Mismatch: ${e.recordCourse}`})]})]}),a.jsx("span",{className:"px-2 py-0.5 text-xs rounded font-bold uppercase "+("present"===e.detectedStatus?"bg-green-100 text-green-800":"absent"===e.detectedStatus?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:e.detectedStatus})]}),a.jsxs("div",{className:"flex gap-2 text-sm text-gray-600",children:[a.jsxs("div",{className:"flex items-center bg-gray-100 px-2 py-1 rounded",children:[a.jsx("span",{className:"text-xs text-gray-400 mr-1",children:"IN"}),e.timeIn||"--:--"]}),a.jsxs("div",{className:"flex items-center bg-gray-100 px-2 py-1 rounded",children:[a.jsx("span",{className:"text-xs text-gray-400 mr-1",children:"OUT"}),e.timeOut||"--:--"]})]})]},t))}),F.length>0&&a.jsx("div",{className:"p-4 border-t bg-white dark:bg-gray-900 dark:border-gray-800",children:a.jsxs("button",{onClick:async()=>{if(0!==F.length)try{const e=F.map(e=>{const t={dayId:S.id,["cadet"===w?"cadetId":"staffId"]:e.id,status:e.detectedStatus,remarks:`Smart Scan: ${e.timeIn?"In "+e.timeIn:""} ${e.timeOut?"Out "+e.timeOut:""}`.trim(),time_in:e.timeIn,time_out:e.timeOut},a="cadet"===w?"/api/attendance/mark":"/api/attendance/mark/staff";return l.post(a,t)});await Promise.all(e),f.success(`Successfully updated ${F.length} records`),ve(S,!0),M([]),J(null),P(!1)}catch(e){f.error("Failed to update some records")}},className:"w-full bg-[var(--primary-color)] text-white py-3 rounded font-bold hover:opacity-90 flex justify-center items-center gap-2",children:[a.jsx(m,{size:20}),"Confirm & Update ",F.length," Records"]})})]})]})}),de&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg w-full max-w-5xl shadow-lg overflow-hidden",children:[a.jsxs("div",{className:"p-4 border-b flex justify-between items-center bg-gray-50 dark:bg-gray-800",children:[a.jsx("h3",{className:"font-bold text-lg text-gray-800 dark:text-gray-100",children:"Import ROTCMIS Export"}),a.jsx("button",{onClick:()=>ie(!1),className:"text-gray-500 hover:text-gray-800",children:a.jsx(c,{size:20})})]}),a.jsxs("div",{className:"p-4 space-y-4",children:[a.jsxs("div",{className:"bg-white dark:bg-gray-900 border rounded p-4",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:"Select ROTCMIS files"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("label",{className:"text-xs",children:"Strategy"}),a.jsxs("select",{value:ye,onChange:e=>be(e.target.value),className:"border rounded px-2 py-1 text-sm",children:[a.jsx("option",{value:"skip-duplicates",children:"Skip duplicates"}),a.jsx("option",{value:"overwrite",children:"Overwrite existing"})]})]})]}),a.jsx("input",{type:"file",multiple:!0,accept:".csv,.xlsx,.xls,.json,.pdf",onChange:e=>{const t=Array.from(e.target.files||[]);ce(e=>[...e,...t])}}),ne.length>0&&a.jsx("div",{className:"mt-3 grid md:grid-cols-3 gap-2",children:ne.map((e,t)=>a.jsxs("div",{className:"flex items-center justify-between p-2 border rounded bg-gray-50 dark:bg-gray-800",children:[a.jsx("div",{className:"text-sm",children:e.name}),a.jsx("button",{onClick:()=>{return e=t,void ce(t=>t.filter((t,a)=>a!==e));var e},className:"text-xs text-red-600 hover:underline",children:"Remove"})]},t))}),a.jsx("div",{className:"mt-3 flex items-center gap-2",children:a.jsx("button",{onClick:async()=>{var e,t;if(0!==ne.length)try{xe(!0);const e=new FormData;ne.forEach(t=>e.append("files",t));const{data:t}=await l.post("/api/integration/rotcmis/validate",e,{headers:{"Content-Type":"multipart/form-data"}});ge(t.records||[]),pe(t.summary||null),fe(new Set((t.records||[]).map((e,t)=>t))),f.success("Parsed ROTCMIS export")}catch(a){f.error((null==(t=null==(e=a.response)?void 0:e.data)?void 0:t.message)||"Validation failed")}finally{xe(!1)}else f.error("Select at least one file")},disabled:oe,className:"px-4 py-2 rounded bg-gray-800 text-white hover:bg-black disabled:opacity-50",children:oe?"Validating…":"Validate Files"})})]}),ue&&a.jsx("div",{className:"bg-white dark:bg-gray-900 border rounded p-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"font-bold",children:"Summary"}),a.jsxs("div",{className:"text-sm text-gray-500",children:["Total: ",ue.total||0," • Valid: ",ue.valid||0," • Invalid: ",ue.invalid||0," • Duplicates: ",ue.duplicates||0]})]})}),me.length>0&&a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"text-sm text-gray-600",children:"Select records to import"}),a.jsx("button",{onClick:()=>{he.size===me.length?fe(new Set):fe(new Set(me.map((e,t)=>t)))},className:"text-sm text-green-700 hover:underline",children:he.size===me.length?"Deselect all":"Select all"})]}),a.jsx("div",{className:"overflow-auto border rounded",children:a.jsxs("table",{className:"min-w-full",children:[a.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800 text-xs uppercase text-gray-500",children:a.jsxs("tr",{children:[a.jsx("th",{className:"p-2 text-left",children:"Pick"}),a.jsx("th",{className:"p-2 text-left",children:"Student ID"}),a.jsx("th",{className:"p-2 text-left",children:"Name"}),a.jsx("th",{className:"p-2 text-left",children:"Date"}),a.jsx("th",{className:"p-2 text-left",children:"Status"}),a.jsx("th",{className:"p-2 text-left",children:"Duplicate"})]})}),a.jsx("tbody",{children:me.map((e,t)=>{var s;const r=(null==(s=e.errors)?void 0:s.length)>0;return a.jsxs("tr",{className:r?"bg-red-50 dark:bg-red-900/20":e.isDuplicateInBatch?"bg-yellow-50 dark:bg-yellow-900/20":"",children:[a.jsx("td",{className:"p-2",children:a.jsx("input",{type:"checkbox",className:"h-3 w-3",checked:he.has(t),onChange:()=>(e=>{const t=new Set(he);t.has(e)?t.delete(e):t.add(e),fe(t)})(t)})}),a.jsx("td",{className:"p-2 font-mono text-sm",children:e.student_id||"—"}),a.jsx("td",{className:"p-2 text-sm",children:e.name||"—"}),a.jsx("td",{className:"p-2 text-sm",children:e.date?new Date(e.date).toLocaleString():"—"}),a.jsx("td",{className:"p-2 text-sm capitalize",children:e.status||"—"}),a.jsx("td",{className:"p-2 text-sm",children:e.isDuplicateInBatch?"Possible duplicate":"—"})]},t)})})]})}),a.jsx("div",{className:"flex justify-end",children:a.jsx("button",{onClick:async()=>{var e,t,a,s,r;try{const s=me.filter((e,t)=>he.has(t));if(0===s.length)return void f.error("No records selected");const r={strategy:ye,records:s},{data:d}=await l.post("/api/integration/rotcmis/import",r);f.success(`Import done: ${(null==(e=null==d?void 0:d.result)?void 0:e.inserted)||0} inserted, ${(null==(t=null==d?void 0:d.result)?void 0:t.updated)||0} updated, ${(null==(a=null==d?void 0:d.result)?void 0:a.skipped)||0} skipped`),ie(!1),S&&ve(S,!0)}catch(d){f.error((null==(r=null==(s=d.response)?void 0:s.data)?void 0:r.message)||"Import failed")}},className:"px-4 py-2 rounded bg-green-700 text-white hover:bg-green-800",children:"Confirm Import"})})]})]})]})}),"excuse"===v?a.jsx(d,{}):a.jsxs("div",{className:"flex flex-col md:flex-row h-full md:h-[calc(100vh-180px)] gap-6",children:[a.jsxs("div",{className:"w-full md:w-1/3 bg-white dark:bg-gray-900 rounded shadow flex flex-col "+(S?"hidden md:flex":""),children:[a.jsxs("div",{className:"p-4 border-b flex justify-between items-center bg-gray-50 dark:bg-gray-800 rounded-t",children:[a.jsx("h2",{className:"font-bold text-lg text-gray-700 dark:text-gray-100",children:"Training Days"}),a.jsx("button",{onClick:()=>O(!0),className:"bg-[var(--primary-color)] text-white p-2 rounded hover:opacity-90",title:"Add Training Day",children:a.jsx(g,{size:20})})]}),a.jsxs("div",{className:"flex-1 overflow-y-auto p-2 space-y-2",children:[C.map(e=>a.jsx("div",{onClick:()=>ve(e),className:"p-4 rounded border cursor-pointer transition "+((null==S?void 0:S.id)===e.id?"bg-[var(--primary-color)]/10 border-[var(--primary-color)]":"hover:bg-gray-50 dark:hover:bg-gray-800 border-gray-200 dark:border-gray-700"),children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsx("div",{className:"font-bold text-gray-800 dark:text-gray-100",children:e.title}),a.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 flex items-center mt-1",children:[a.jsx(i,{size:14,className:"mr-1"}),new Date(e.date).toLocaleDateString()]})]}),a.jsx("button",{onClick:a=>(async(e,a)=>{if(a.stopPropagation(),confirm("Delete this training day and all associated records?"))try{await l.delete(`/api/attendance/days/${e}`),(null==S?void 0:S.id)===e&&$(null),await t("admin","training_days",null),je(!0)}catch(s){alert("Error deleting day")}})(e.id,a),className:"text-gray-400 hover:text-red-600",children:a.jsx(u,{size:16})})]})},e.id)),0===C.length&&a.jsx("div",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:"No training days found."})]})]}),a.jsx("div",{className:"w-full md:w-2/3 bg-white dark:bg-gray-900 rounded shadow flex flex-col "+(S?"":"hidden md:flex"),children:S?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"p-4 border-b bg-gray-50 dark:bg-gray-800 rounded-t",children:[a.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start gap-2 mb-2",children:[a.jsxs("div",{children:[a.jsxs("button",{onClick:()=>$(null),className:"md:hidden text-gray-500 dark:text-gray-400 mb-2 flex items-center text-sm",children:[a.jsx(p,{className:"rotate-180 mr-1",size:16})," Back to List"]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-gray-100",children:S.title}),a.jsx("button",{type:"button",onClick:()=>le(e=>!e),className:"touch-target px-2 py-1 rounded border border-gray-300 dark:border-gray-600 text-xs text-gray-600 dark:text-gray-300 hover:bg-white/10 hover-highlight","aria-expanded":re,"aria-controls":"attendance-controls",title:re?"Collapse controls":"Expand controls",children:re?"Hide Controls":"Show Controls"})]}),a.jsx("p",{className:"text-gray-600 dark:text-gray-300 mt-1",children:S.description||"No description"})]}),a.jsxs("div",{className:"flex flex-col items-end gap-2 mt-2 md:mt-0",children:[a.jsxs("div",{className:"flex gap-2",children:[a.jsxs("button",{onClick:()=>{if(!S)return;const e=(new Date).toLocaleString(),t=$e.length;let a=null,s=null;if("cadet"===w){const e=e=>(e.corp_position||e.battalion||"").toLowerCase();a=I.find(t=>e(t).includes("bde s1"))||I.find(t=>e(t).includes("s1")),s=I.find(t=>{const a=e(t);return a.includes("corp cmdr")||a.includes("corp commander")||a.includes("corps commander")})}const r=a?`${a.first_name} ${a.last_name}`:"VINCENT R URTAL",l=a?`${a.rank} • S1/Personnel Officer`:"CDT LIEUTENANT COLONEL (1CL) • S1/Personnel Officer",d=s?`${s.first_name} ${s.last_name}`:"JOHN MARK C LANGUIDO",i=s?`${s.rank} • Corp Commander`:"CDT COLONEL (1CL) • Corp Commander",n=[[`Report,Attendance,Day,"${S.title}"`,`Generated,"${e}"`,""].join("\n"),[["Cadet/Staff ID","Name","Role/Rank","Status","Time In","Time Out","Remarks"].join(","),...$e.map(e=>{const t=`"${e.last_name}, ${e.first_name}"`;return["cadet"===w?e.cadet_id:e.staff_id,t,"cadet"===w?e.rank:e.role||"Instructor",e.status,e.time_in,e.time_out,`"${e.remarks||""}"`].join(",")})].join("\n"),["",`Prepared By,"${r}","${l}"`,`Certified Correct,"${d}","${i}"`,`Total Records,${t}`].join("\n")].join("\n"),c=new Blob([n],{type:"text/csv"}),o=window.URL.createObjectURL(c),x=document.createElement("a");x.href=o,x.download=`attendance_${S.title.replace(/\s+/g,"_")}_${(new Date).toISOString().split("T")[0]}.csv`,x.click(),window.URL.revokeObjectURL(o)},className:"flex items-center text-sm bg-[var(--primary-color)] text-white px-3 py-1 rounded hover:opacity-90 transition",title:"Export CSV",children:[a.jsx(h,{size:16,className:"mr-2"})," Export"]}),a.jsx("input",{ref:W,type:"file",accept:".pdf,.doc,.docx,.xlsx,.xls,.csv,.png,.jpg,.jpeg,.bmp,.webp,.gif,.tiff",className:"hidden",onChange:async e=>{var t,a,s,r;if(!S)return;const d=null==(t=e.target.files)?void 0:t[0];if(d){K(!0);try{const e=new FormData;e.append("file",d),e.append("dayId",S.id);const t=(null==(a=(await l.post("/api/attendance/import",e,{headers:{"Content-Type":"multipart/form-data"}})).data)?void 0:a.message)||"Import complete";f.success(t),ve(S,!0)}catch(i){const e=(null==(r=null==(s=i.response)?void 0:s.data)?void 0:r.message)||"Failed to import file";f.error(e)}finally{K(!1),e.target&&(e.target.value="")}}}}),a.jsxs("button",{onClick:()=>ie(!0),className:"flex items-center text-sm bg-gray-700 text-white px-3 py-1 rounded hover:bg-black transition",title:"Import ROTCMIS",children:[a.jsx(n,{size:16,className:"mr-2"})," Import ROTCMIS"]}),a.jsxs("button",{onClick:()=>P(!0),className:"flex items-center text-sm bg-gray-800 text-white px-3 py-1 rounded hover:bg-black transition",children:[a.jsx(o,{size:16,className:"mr-2"})," Smart Scan"]})]}),a.jsxs("div",{className:"flex flex-wrap gap-2 text-sm",children:[a.jsxs("div",{className:"flex items-center text-green-700 bg-green-50 px-2 py-1 rounded",children:[a.jsx(m,{size:16,className:"mr-1"})," Present: ",Ie.present||0]}),a.jsxs("div",{className:"flex items-center text-red-700 bg-red-50 px-2 py-1 rounded",children:[a.jsx(y,{size:16,className:"mr-1"})," Absent: ",Ie.absent||0]}),a.jsxs("div",{className:"flex items-center text-yellow-700 bg-yellow-50 px-2 py-1 rounded",children:[a.jsx(b,{size:16,className:"mr-1"})," Late: ",Ie.late||0]}),a.jsxs("div",{className:"flex items-center text-blue-700 bg-blue-50 px-2 py-1 rounded",children:[a.jsx(j,{size:16,className:"mr-1"})," Excused: ",Ie.excused||0]})]})]})]}),a.jsxs("div",{id:"attendance-controls",className:"grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 transition-all duration-300 ease-in-out overflow-hidden "+(re?"opacity-100 max-h-[800px]":"opacity-0 max-h-0 pointer-events-none"),"aria-hidden":!re,children:[a.jsx("div",{className:"md:col-span-3 flex justify-center mb-2",children:a.jsxs("div",{className:"bg-gray-200 dark:bg-gray-800 rounded p-1 flex",children:[a.jsx("button",{className:"px-4 py-1 rounded text-sm font-semibold transition "+("cadet"===w?"bg-white dark:bg-gray-900 shadow text-[var(--primary-color)]":"text-gray-600 dark:text-gray-300"),onClick:()=>k("cadet"),children:"Cadets"}),a.jsx("button",{className:"px-4 py-1 rounded text-sm font-semibold transition "+("staff"===w?"bg-white dark:bg-gray-900 shadow text-[var(--primary-color)]":"text-gray-600 dark:text-gray-300"),onClick:()=>k("staff"),children:"Training Staff"})]})}),a.jsx("input",{placeholder:"Search Name...",className:"border p-2 rounded bg-white dark:bg-gray-900 dark:border-gray-700 dark:text-gray-100",value:ae,onChange:e=>se(e.target.value)}),"cadet"===w&&a.jsxs(a.Fragment,{children:[a.jsx("input",{placeholder:"Company (A/B/C)",className:"border p-2 rounded bg-white dark:bg-gray-900 dark:border-gray-700 dark:text-gray-100",value:X,onChange:e=>Y(e.target.value)}),a.jsx("input",{placeholder:"Platoon (1/2/3)",className:"border p-2 rounded bg-white dark:bg-gray-900 dark:border-gray-700 dark:text-gray-100",value:ee,onChange:e=>te(e.target.value)})]})]})]}),a.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:0===$e.length?a.jsx("div",{className:"text-center text-gray-500 dark:text-gray-400 py-10",children:"No records found matching filters."}):a.jsx("div",{className:"overflow-auto border rounded",children:a.jsxs("table",{className:"w-full min-w-[900px]",children:[a.jsx("thead",{className:"text-xs uppercase tracking-wider text-gray-600 dark:text-gray-300",children:a.jsxs("tr",{className:"bg-gradient-to-r from-black/10 to-black/5 dark:from-white/5 dark:to-white/10 border-b border-gray-200 dark:border-gray-800",children:[a.jsx("th",{className:"p-3 text-left font-semibold",children:"Name"}),"cadet"===w&&a.jsx("th",{className:"p-3 text-left font-semibold",children:"Company/Platoon"}),a.jsx("th",{className:"p-3 text-left font-semibold",children:"Status"}),a.jsx("th",{className:"p-3 text-left font-semibold",children:"Time"}),a.jsx("th",{className:"p-3 text-left font-semibold",children:"Remarks"}),a.jsx("th",{className:"p-3 text-right font-semibold",children:"Actions"})]})}),a.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-800",children:$e.map(e=>{const s="cadet"===w?e.cadet_id:e.staff_id,r=e.status,d=(e,t)=>a.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-bold uppercase ${{present:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",absent:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",excused:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",late:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300"}[t]}`,children:e});return a.jsxs("tr",{className:"bg-white dark:bg-gray-900 hover:bg-black/5 dark:hover:bg-white/5 transition-colors",children:[a.jsxs("td",{className:"p-3 align-middle",children:[a.jsxs("div",{className:"font-semibold text-gray-800 dark:text-gray-100",children:[e.last_name,", ",e.first_name]}),"staff"===w&&a.jsx("div",{className:"text-xs text-gray-500",children:e.role||"Instructor"})]}),"cadet"===w&&a.jsx("td",{className:"p-3 align-middle",children:a.jsxs("span",{className:"text-xs bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 px-2 py-0.5 rounded",children:[e.company,"/",e.platoon]})}),a.jsxs("td",{className:"p-3 align-middle",children:["present"===r&&d("Present","present"),"absent"===r&&d("Absent","absent"),"excused"===r&&d("Excused","excused"),"late"===r&&d("Late","late"),!r&&a.jsx("span",{className:"text-xs text-gray-500",children:"—"})]}),a.jsx("td",{className:"p-3 align-middle",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("label",{className:"sr-only",htmlFor:`in-${s}`,children:"Time In"}),a.jsx("input",{id:`in-${s}`,type:"time",className:"border rounded px-2 py-1 text-xs bg-white dark:bg-gray-900 dark:border-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-[var(--primary-color)] focus:outline-none transition-shadow",value:e.time_in||"",onChange:e=>_e(s,"time_in",e.target.value),onBlur:e=>Se(s,"time_in",e.target.value)}),a.jsx("span",{className:"text-xs text-gray-400",children:"–"}),a.jsx("label",{className:"sr-only",htmlFor:`out-${s}`,children:"Time Out"}),a.jsx("input",{id:`out-${s}`,type:"time",className:"border rounded px-2 py-1 text-xs bg-white dark:bg-gray-900 dark:border-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-[var(--primary-color)] focus:outline-none transition-shadow",value:e.time_out||"",onChange:e=>_e(s,"time_out",e.target.value),onBlur:e=>Se(s,"time_out",e.target.value)})]})}),a.jsxs("td",{className:"p-3 align-middle",children:[a.jsx("label",{className:"sr-only",htmlFor:`remarks-${s}`,children:"Remarks"}),a.jsx("input",{id:`remarks-${s}`,className:"w-full border-b border-gray-300 dark:border-gray-600 focus:border-[var(--primary-color)] outline-none text-xs bg-transparent dark:text-gray-100",placeholder:"Remarks…",value:e.remarks||"",onChange:e=>(async(e,a)=>{const s=I.map(t=>("cadet"===w?t.cadet_id===e:t.staff_id===e)?{...t,remarks:a}:t);if(D(s),S){const e=`${S.id}_${w}`;t("attendance_by_day",e,{data:s,timestamp:Date.now()}).catch(console.error)}})(s,e.target.value),onBlur:a=>(async(e,a,s)=>{try{const a=I.find(t=>"cadet"===w?t.cadet_id===e:t.staff_id===e),r={dayId:S.id,["cadet"===w?"cadetId":"staffId"]:e,status:s||(null==a?void 0:a.status)||"present",remarks:(null==a?void 0:a.remarks)||"",time_in:(null==a?void 0:a.time_in)||"",time_out:(null==a?void 0:a.time_out)||""},d="cadet"===w?"/api/attendance/mark":"/api/attendance/mark/staff";await l.post(d,r),"cadet"===w&&(await t("grading","cadets_list",null),await t("admin","cadets_list",null))}catch(r){}})(s,a.target.value,e.status)})]}),a.jsx("td",{className:"p-3 align-middle",children:a.jsxs("div",{className:"flex justify-end gap-2",children:[a.jsx("button",{onClick:()=>Ce(s,"present"),className:"px-2.5 py-1 rounded-full text-xs font-medium transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[var(--primary-color)] "+("present"===r?"bg-green-600 text-white":"bg-green-50 text-green-700 hover:bg-green-100"),"aria-pressed":"present"===r,children:"Present"}),a.jsx("button",{onClick:()=>Ce(s,"absent"),className:"px-2.5 py-1 rounded-full text-xs font-medium transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[var(--primary-color)] "+("absent"===r?"bg-red-600 text-white":"bg-red-50 text-red-700 hover:bg-red-100"),"aria-pressed":"absent"===r,children:"Absent"}),a.jsx("button",{onClick:()=>Ce(s,"excused"),className:"px-2.5 py-1 rounded-full text-xs font-medium transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[var(--primary-color)] "+("excused"===r?"bg-blue-600 text-white":"bg-blue-50 text-blue-700 hover:bg-blue-100"),"aria-pressed":"excused"===r,children:"Excused"})]})})]},s)})})]})})})]}):a.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400 dark:text-gray-500",children:[a.jsx(i,{size:64,className:"mb-4 opacity-20"}),a.jsx("p",{className:"text-lg",children:"Select a training day to view attendance"})]})})]}),L&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded p-6 w-full max-w-md shadow-xl",children:[a.jsx("h3",{className:"text-lg font-bold mb-4 text-gray-800 dark:text-gray-100",children:"New Training Day"}),a.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{await l.post("/api/attendance/days",T),await t("admin","training_days",null),je(!0),O(!1),E({date:"",title:"",description:""})}catch(a){alert("Error creating training day")}},className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200",children:"Date"}),a.jsx("input",{type:"date",required:!0,className:"w-full border p-2 rounded bg-white dark:bg-gray-900 dark:border-gray-700 dark:text-gray-100",value:T.date,onChange:e=>E({...T,date:e.target.value})})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200",children:"Title"}),a.jsx("input",{type:"text",required:!0,placeholder:"e.g. Drill Day 1",className:"w-full border p-2 rounded bg-white dark:bg-gray-900 dark:border-gray-700 dark:text-gray-100",value:T.title,onChange:e=>E({...T,title:e.target.value})})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200",children:"Description"}),a.jsx("textarea",{className:"w-full border p-2 rounded bg-white dark:bg-gray-900 dark:border-gray-700 dark:text-gray-100",value:T.description,onChange:e=>E({...T,description:e.target.value})})]}),a.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[a.jsx("button",{type:"button",onClick:()=>O(!1),className:"px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded",children:"Cancel"}),a.jsx("button",{type:"submit",className:"px-4 py-2 bg-[var(--primary-color)] text-white rounded hover:opacity-90",children:"Create Day"})]})]})]})})]})};export{v as default};
