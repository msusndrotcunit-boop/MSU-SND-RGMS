import{u as e,j as t,c as a}from"./index-CS3KqmWJ.js";import{u as s,f as i,r as n,b as r,L as l,O as o}from"./vendor-react-BJYbxeCs.js";import{c,a as d}from"./vendor-utils-qHW_S61q.js";import{F as h,X as m,aA as x,p as g,w as u,av as p,x as f,G as b,I as v,o as y,a as w,aB as j,N,aw as k,al as C,z as _,n as S}from"./vendor-ui-Cf-65S3f.js";import{a as z,g as M}from"./image-DaHBJgAL.js";import{S as A,M as I,A as E,C as P,a as D,F as H,N as T}from"./CrossPlatformStandardizer-Lc6mSZwB.js";import"./useResponsive-XC39aU2L.js";const L=()=>{const{logout:L,user:$}=e(),G=s(),O=i(),[R,B]=n.useState(!1),[V,W]=n.useState(!1);r.useEffect(()=>{$&&"cadet"===$.role&&!$.isProfileCompleted&&"/cadet/profile"!==O.pathname&&G("/cadet/profile",{replace:!0})},[$,O.pathname,G]),r.useEffect(()=>{try{localStorage.getItem("rgms_permissions_seen")||"undefined"==typeof window||"undefined"==typeof navigator||W(!0)}catch{}},[]),r.useEffect(()=>{try{R?(document.body.style.overflow="hidden",document.body.style.touchAction="none"):(document.body.style.overflow="",document.body.style.touchAction="")}catch{}return()=>{try{document.body.style.overflow="",document.body.style.touchAction=""}catch{}}},[R]);const[Y,q]=n.useState(null),[F,U]=n.useState(!1),[J,K]=n.useState(!1),[Q,Z]=n.useState(0),[X,ee]=n.useState({status:"unknown"}),[te,ae]=n.useState(0),[se,ie]=n.useState(0),[ne,re]=n.useState(!1),[le,oe]=n.useState([]),[ce,de]=n.useState([]),he=async()=>{try{const e=((await d.get("/api/cadet/notifications")).data||[]).filter(e=>e&&"admin_broadcast"===e.type);oe(e),ae(e.length)}catch(e){}},me=async()=>{try{const e=((await d.get("/api/messages/my")).data||[]).filter(e=>e&&"admin"===e.sender_role);de(e)}catch(e){}};r.useEffect(()=>{$&&"cadet"===$.role&&(he(),me())},[$]),r.useEffect(()=>{const e=((null==ce?void 0:ce.length)||0)+((null==le?void 0:le.length)||0);ie(e)},[ce,le]);const xe=[{title:"Dashboard Overview",description:"Stay updated with the latest activities and announcements.",icon:N},{title:"Profile Management",description:"Keep your personal information up to date.",icon:w},{title:"QR Code Attendance",description:"Use your unique QR code for quick attendance scanning during training.",icon:k},{title:"Performance Tracking",description:"Monitor your grades, merits, and demerits in real-time.",icon:C}];r.useEffect(()=>{(async()=>{if($&&"cadet"===$.role&&$.isProfileCompleted)try{const e=await d.get("/api/cadet/profile");q(e.data),e.data&&!e.data.has_seen_guide&&U(!0)}catch(e){}})()},[$]),r.useEffect(()=>{let e;const t=()=>{try{e=new EventSource("/api/attendance/events"),e.onmessage=e=>{try{const t=JSON.parse(e.data||"{}");if("admin_broadcast"===t.type&&"cadet"===(null==$?void 0:$.role))he(),me(),navigator.vibrate&&navigator.vibrate(80),re(!0),setTimeout(()=>re(!1),1200);else if("grade_updated"===t.type&&"cadet"===(null==$?void 0:$.role))S.success("Grades updated"),d.get("/api/cadet/my-grades").then(async e=>{await a("dashboard","cadet_grades",{data:e.data,timestamp:Date.now()})}).catch(()=>{}),d.get("/api/cadet/my-merit-logs").then(async e=>{await a("dashboard","cadet_logs",{data:e.data,timestamp:Date.now()})}).catch(()=>{});else if("attendance_updated"===t.type){(!t.cadetId||$&&$.cadetId&&t.cadetId===$.cadetId)&&d.get("/api/attendance/my-history").then(async e=>{await a("attendance_by_day","my_history",{data:e.data,timestamp:Date.now()})}).catch(()=>{})}else"cadet_profile_updated"===t.type&&"cadet"===(null==$?void 0:$.role)&&t.cadetId===(null==$?void 0:$.cadetId)&&d.get("/api/cadet/profile").then(e=>{q(e.data)}).catch(()=>{})}catch{}},e.onerror=()=>{e&&e.close(),setTimeout(t,3e3)}}catch{}};return t(),()=>{try{e&&e.close()}catch{}}},[]),r.useEffect(()=>{const e=async()=>{try{const e=await d.get("/api/health");ee(e.data||{status:"ok",db:"connected"})}catch(e){ee({status:"ok",db:"disconnected"})}};e();const t=setInterval(e,2e4);return()=>clearInterval(t)},[]);const ge=async()=>{try{await d.post("/api/cadet/acknowledge-guide"),U(!1)}catch(e){U(!1)}},ue=async()=>{try{await d.post("/api/cadet/acknowledge-guide"),K(!1),S.success("You're all set! Welcome aboard.")}catch(e){K(!1)}},pe=n.useMemo(()=>{const e=z(null==Y?void 0:Y.profile_pic,null==$?void 0:$.cadetId,"cadets");return e||M(null==$?void 0:$.cadetId,"cadets")},[null==Y?void 0:Y.profile_pic,null==$?void 0:$.cadetId]),fe=n.useMemo(()=>((null==Y?void 0:Y.rank)||"Cadet").toString().trim(),[null==Y?void 0:Y.rank]),be=n.useMemo(()=>{const e=[null==Y?void 0:Y.first_name,null==Y?void 0:Y.middle_name,null==Y?void 0:Y.last_name,null==Y?void 0:Y.suffix_name].filter(Boolean);return e.length?e.join(" "):(null==$?void 0:$.username)||""},[null==Y?void 0:Y.first_name,null==Y?void 0:Y.middle_name,null==Y?void 0:Y.last_name,null==Y?void 0:Y.suffix_name,null==$?void 0:$.username]);return t.jsx(A,{children:t.jsx(I,{children:t.jsx(E,{preserveFixed:!0,children:t.jsx(P,{children:t.jsxs(D,{className:"flex min-h-screen app-bg overflow-hidden readable-text text-balance",children:[t.jsx(h,{position:"top-center",reverseOrder:!1}),R&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden",onClick:()=>B(!1)}),t.jsxs(H,{position:"left",respectSafeArea:!0,id:"cadet-sidebar","aria-hidden":!R,className:c("w-[85vw] max-w-sm md:w-64 bg-[var(--primary-color)] text-white flex flex-col transform transform-gpu transition-transform duration-300 ease-in-out fixed inset-y-0 left-0 z-50 md:fixed md:translate-x-0 md:flex-shrink-0 md:pointer-events-auto max-h-[100dvh] overflow-hidden overscroll-contain",R?"translate-x-0 pointer-events-auto":"-translate-x-full pointer-events-none"),children:[t.jsxs("div",{className:"p-6 text-xl font-bold border-b border-white/10 flex justify-between items-center",children:[t.jsx("span",{children:"ROTC Cadet"}),t.jsx("button",{onClick:()=>B(!1),className:"md:hidden text-green-200 hover:text-white",children:t.jsx(m,{size:24})})]}),t.jsxs("div",{className:"px-6 py-4 border-b border-white/10 flex flex-col items-center text-center",children:[t.jsxs("figure",{className:"w-full flex flex-col items-center",children:[t.jsx(l,{to:"/cadet/profile",className:"w-24 h-24 md:w-20 md:h-20 rounded-full bg-white mb-2 overflow-hidden ring-2 ring-yellow-400 shadow-md","aria-label":"View profile",children:t.jsx("img",{src:pe,alt:be?`${fe} ${be}`:"Cadet profile photo","aria-label":be?`${fe} ${be}`:"Cadet profile photo",className:"w-full h-full object-cover",onError:e=>{e.target.src=M(null==$?void 0:$.cadetId,"cadets")}},pe)}),t.jsxs("figcaption",{className:"w-full",children:[t.jsx("div",{id:"cadet-rank",className:"text-[11px] md:text-xs tracking-wide uppercase text-yellow-300 font-extrabold","aria-live":"polite",children:fe||"Cadet"}),t.jsx("div",{id:"cadet-name",className:"text-sm md:text-base font-semibold text-white leading-tight break-words",children:be||"Profile Incomplete"}),(null==Y?void 0:Y.email)&&t.jsx("div",{className:"text-[11px] text-green-200 mt-1 w-full text-center overflow-hidden whitespace-nowrap truncate max-w-[16rem] mx-auto",title:Y.email,children:Y.email})]})]}),!Y&&t.jsx("div",{className:"sr-only",role:"status","aria-live":"polite",children:"Loading profile information"})]}),t.jsxs("nav",{className:"flex-1 p-4 space-y-2 overflow-y-auto",children:[t.jsxs(l,{to:"/cadet/home",onClick:()=>B(!1),className:c("nav-link space-x-3 transition hover-highlight","/cadet/home"===O.pathname?"bg-green-700 text-white":"text-green-200 hover:bg-green-800 hover:text-white"),children:[t.jsx(x,{size:20}),t.jsx("span",{children:"Home"})]}),t.jsxs(l,{to:"/cadet/dashboard",onClick:()=>B(!1),className:c("nav-link space-x-3 transition hover-highlight","/cadet/dashboard"===O.pathname?"bg-green-700 text-white":"text-green-200 hover:bg-green-800 hover:text-white"),children:[t.jsx(g,{size:20}),t.jsx("span",{children:"My Portal"})]}),t.jsxs(l,{to:"/cadet/achievements",onClick:()=>B(!1),className:c("nav-link space-x-3 transition hover-highlight","/cadet/achievements"===O.pathname?"bg-green-700 text-white":"text-green-200 hover:bg-green-800 hover:text-white"),children:[t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("path",{d:"M6 9H4.5a2.5 2.5 0 0 1 0-5H6"}),t.jsx("path",{d:"M18 9h1.5a2.5 2.5 0 0 0 0-5H18"}),t.jsx("path",{d:"M4 22h16"}),t.jsx("path",{d:"M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"}),t.jsx("path",{d:"M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"}),t.jsx("path",{d:"M18 2H6v7a6 6 0 0 0 12 0V2Z"})]}),t.jsx("span",{children:"Achievements"})]}),t.jsxs(l,{to:"/cadet/ask-admin",onClick:()=>B(!1),className:c("nav-link space-x-3 transition hover-highlight","/cadet/ask-admin"===O.pathname?"bg-green-700 text-white":"text-green-200 hover:bg-green-800 hover:text-white"),children:[t.jsx(u,{size:20}),t.jsx("span",{children:"Ask Admin"})]}),t.jsxs(l,{to:"/cadet/about",onClick:()=>B(!1),className:c("nav-link space-x-3 transition hover-highlight","/cadet/about"===O.pathname?"bg-green-700 text-white":"text-green-200 hover:bg-green-800 hover:text-white"),children:[t.jsx(p,{size:20}),t.jsx("span",{children:"About"})]}),t.jsxs(l,{to:"/cadet/settings",onClick:()=>B(!1),className:c("nav-link space-x-3 transition hover-highlight","/cadet/settings"===O.pathname?"bg-green-700 text-white":"text-green-200 hover:bg-green-800 hover:text-white"),children:[t.jsx(f,{size:20}),t.jsx("span",{children:"Settings"})]})]}),t.jsx("div",{className:"mt-auto p-4 border-t border-white/10 bg-black/10 backdrop-blur pb-[var(--sab)] sticky bottom-0",children:t.jsxs("button",{onClick:()=>{B(!1),L(),G("/login")},className:"w-full flex items-center justify-center gap-2 py-3 rounded-md bg-white/10 hover:bg-white/15 text-white hover:opacity-95 transition",type:"button","aria-label":"Logout",children:[t.jsx(b,{size:20}),t.jsx("span",{children:"Logout"})]})})]}),t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden md:ml-64",children:[t.jsxs(H,{position:"top",respectSafeArea:!0,className:"bg-white shadow p-4 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("button",{onClick:()=>B(!R),"aria-controls":"cadet-sidebar","aria-expanded":R,className:"mr-4 text-gray-600 hover:text-gray-900 md:hidden touch-target p-2",style:{minHeight:"48px",minWidth:"48px"},children:t.jsx(v,{size:28})}),t.jsxs("h1",{className:"text-xl font-semibold text-gray-800",children:[O.pathname.includes("/cadet/home")&&"Home",O.pathname.includes("/cadet/dashboard")&&"My Portal",O.pathname.includes("/cadet/profile")&&"My Profile",O.pathname.includes("/cadet/about")&&"About"]})]}),t.jsx("div",{className:"flex items-center space-x-4",children:t.jsx(T,{type:"Messages",icon:y,count:se,notifications:[...le,...ce].sort((e,t)=>new Date(t.created_at)-new Date(e.created_at)),navigateToMessage:"/cadet/ask-admin",navigateToBroadcast:"/cadet/broadcasts",onMarkRead:async e=>{try{await d.delete(`/api/messages/${e}`).catch(()=>{}),await d.delete(`/api/notifications/${e}`).catch(()=>{}),de(t=>t.filter(t=>t.id!==e)),oe(t=>t.filter(t=>t.id!==e))}catch(t){}},onClear:async()=>{try{await Promise.all(ce.map(e=>d.delete(`/api/messages/${e.id}`).catch(()=>{}))),await d.delete("/api/cadet/notifications/delete-all").catch(()=>{}),de([]),oe([])}catch(e){}}})})]}),X&&"disconnected"===X.db&&t.jsx("div",{className:"bg-yellow-600 text-white text-sm p-2 text-center",children:"Degraded mode: Database disconnected. Your changes will be limited until service restores."}),t.jsx(D,{className:"flex-1 overflow-auto p-6 readable-text text-balance",enableKeyboardAdjustment:!0,enableScrollAdjustment:!0,children:t.jsx(n.Suspense,{fallback:t.jsx("div",{className:"flex justify-center items-center h-64",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-700"})}),children:t.jsx(o,{})})})]}),F&&Y&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[60] p-4",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-2xl max-w-md w-full p-8 text-center animate-fade-in-up relative",children:[t.jsx("button",{onClick:ge,className:"absolute top-4 right-4 text-gray-400 hover:text-gray-600",children:t.jsx(m,{size:24})}),t.jsx("div",{className:"mx-auto w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6",children:t.jsx(w,{size:40,className:"text-green-700"})}),t.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Welcome!"}),t.jsxs("h3",{className:"text-xl font-semibold text-green-700 mb-4",children:[Y.rank," ",Y.first_name," ",Y.last_name]}),t.jsx("p",{className:"text-gray-600 mb-8",children:"to MSU-SND ROTC Grading Management System"}),t.jsxs("button",{onClick:()=>{U(!1),K(!0)},className:"w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 transition flex items-center justify-center mb-3 hover-highlight",children:["Start User Guide ",t.jsx(j,{size:20,className:"ml-2"})]}),t.jsx("button",{onClick:ge,className:"w-full bg-white border border-gray-300 text-gray-600 py-3 rounded-lg font-bold hover:bg-gray-50 transition hover-highlight",children:"Skip Guide"})]})}),J&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[60] p-4",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-2xl max-w-lg w-full p-8 relative animate-fade-in-up",children:[t.jsx("div",{className:"absolute top-6 right-8 flex space-x-2",children:xe.map((e,a)=>t.jsx("div",{className:"w-2 h-2 rounded-full transition-all "+(a===Q?"bg-green-600 w-4":"bg-gray-300")},a))}),t.jsxs("div",{className:"mb-8 mt-4 text-center",children:[t.jsx("div",{className:"mx-auto w-24 h-24 bg-green-50 rounded-full flex items-center justify-center mb-6 shadow-inner",children:r.createElement(xe[Q].icon,{size:48,className:"text-green-600"})}),t.jsx("h3",{className:"text-2xl font-bold text-gray-800 mb-4",children:xe[Q].title}),t.jsx("p",{className:"text-gray-600 text-lg leading-relaxed",children:xe[Q].description})]}),t.jsxs("div",{className:"flex justify-between items-center mt-8",children:[t.jsx("button",{onClick:()=>{Q>0?Z(e=>e-1):K(!1)},className:"text-gray-500 hover:text-gray-800 font-semibold px-4 py-2 "+(0===Q?"invisible":""),children:"Back"}),t.jsxs("button",{onClick:()=>{Q<xe.length-1?Z(e=>e+1):ue()},className:"bg-green-700 text-white px-8 py-3 rounded-lg font-bold hover:bg-green-800 transition shadow-lg flex items-center",children:[Q===xe.length-1?"Get Started":"Next",Q<xe.length-1&&t.jsx(_,{size:20,className:"ml-1"})]})]})]})}),V&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6",children:[t.jsx("h2",{className:"text-lg font-bold text-gray-800 mb-2",children:"Allow Location Access"}),t.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"To show local weather advisories, this app requests access to your location. You may decline; we will use approximate location or defaults."}),t.jsx("p",{className:"text-xs text-gray-500 mb-4",children:"You can change location permission anytime in your browser or device settings."}),t.jsxs("div",{className:"flex justify-end space-x-3",children:[t.jsx("button",{type:"button",onClick:()=>{try{localStorage.setItem("rgms_permissions_seen","true")}catch{}W(!1)},className:"px-4 py-2 text-sm rounded border border-gray-300 text-gray-600 hover:bg-gray-50 hover-highlight",children:"Not now"}),t.jsx("button",{type:"button",onClick:()=>{try{navigator.geolocation&&navigator.geolocation.getCurrentPosition(()=>{},()=>{},{enableHighAccuracy:!0,timeout:1e4})}catch{}try{localStorage.setItem("rgms_permissions_seen","true")}catch{}W(!1)},className:"px-4 py-2 text-sm rounded bg-green-700 text-white hover:bg-green-800 hover-highlight",children:"Allow location"})]})]})})]})})})})})};export{L as default};
