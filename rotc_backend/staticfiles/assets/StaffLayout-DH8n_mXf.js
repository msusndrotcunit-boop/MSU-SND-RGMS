import{u as e,j as t,c as a}from"./index-CS3KqmWJ.js";import{u as s,f as i,r as l,b as o,L as n,O as r}from"./vendor-react-BJYbxeCs.js";import{c,a as d}from"./vendor-utils-qHW_S61q.js";import{F as h,X as m,aA as f,L as x,p,q as u,t as v,u as g,aD as b,H as y,a as j,x as w,G as k,I as C,o as N}from"./vendor-ui-Cf-65S3f.js";import{S as P,M as z,A as S,C as _,a as A,F as D,N as I}from"./CrossPlatformStandardizer-Lc6mSZwB.js";import{g as T,a as E}from"./image-DaHBJgAL.js";import"./useResponsive-XC39aU2L.js";const O=()=>{const{user:O,logout:M}=e(),H=s(),L=i(),[R,q]=l.useState(!1),[F,$]=l.useState(0),[G,J]=l.useState(0),[Y,B]=l.useState(!1),[K,Q]=l.useState([]),[U,W]=l.useState([]),[V,X]=l.useState(null),[Z,ee]=l.useState(null),[te,ae]=l.useState(!1),se=async()=>{try{const e=await d.get("/api/staff/notifications");Q(e.data||[])}catch(e){}},ie=async()=>{try{const e=await d.get("/api/messages/my");W(e.data||[])}catch(e){}};o.useEffect(()=>{O&&(se(),ie())},[O]),o.useEffect(()=>{const e=((null==U?void 0:U.length)||0)+((null==K?void 0:K.length)||0);J(e)},[U,K]),o.useEffect(()=>{O&&!O.isProfileCompleted&&"/staff/profile"!==L.pathname&&H("/staff/profile")},[O,L.pathname,H]),o.useEffect(()=>{(async()=>{var e;if(O&&"training_staff"===O.role)try{const t=await d.get("/api/staff/me");X((null==(e=t.data)?void 0:e.role)||null),ee(t.data)}catch{}})()},[O]),o.useEffect(()=>{try{localStorage.getItem("rgms_permissions_seen")||"undefined"==typeof window||"undefined"==typeof navigator||ae(!0)}catch{}},[]);const le="Commandant"===V||"Assistant Commandant"===V||"NSTP Director"===V||"ROTC Coordinator"===V||"Admin NCO"===V;return o.useEffect(()=>{let e;const t=()=>{try{e=new EventSource("/api/attendance/events"),e.onmessage=e=>{try{const t=JSON.parse(e.data||"{}");if("ask_admin_reply"===t.type||"staff_chat"===t.type||"cadet_notification"===t.type||"admin_broadcast"===t.type)se(),ie(),navigator.vibrate&&navigator.vibrate(80),B(!0),setTimeout(()=>B(!1),1200);else if("staff_attendance_updated"===t.type){O&&"training_staff"===O.role&&(!t.staffId||O&&O.staffId&&t.staffId===O.staffId)&&d.get("/api/attendance/my-history/staff").then(async e=>{await a("attendance_by_day","my_staff_history",{data:e.data,timestamp:Date.now()})}).catch(()=>{})}}catch{}},e.onerror=()=>{e&&e.close(),setTimeout(t,3e3)}}catch{}};return t(),()=>{try{e&&e.close()}catch{}}},[]),t.jsx(P,{children:t.jsx(z,{children:t.jsx(S,{preserveFixed:!0,children:t.jsx(_,{children:t.jsxs(A,{className:"flex min-h-screen app-bg overflow-hidden",children:[t.jsx(h,{position:"top-right",reverseOrder:!1}),R&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden",onClick:()=>q(!1)}),t.jsxs(D,{position:"left",respectSafeArea:!0,className:c("w-[85vw] max-w-sm md:w-64 bg-primary-surface text-white flex flex-col transform transition-transform duration-300 ease-in-out fixed inset-y-0 left-0 z-50 md:fixed md:translate-x-0 md:flex-shrink-0 md:pointer-events-auto max-h-[100dvh] overflow-hidden",R?"translate-x-0 pointer-events-auto":"-translate-x-full pointer-events-none"),children:[t.jsxs("div",{className:"p-6 border-b border-white/10",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("span",{className:"text-xl font-bold",children:["Commandant","NSTP Director","Admin NCO","ROTC Coordinator"].includes(V)?"Command Group":"Training Staff"}),t.jsx("div",{className:"flex items-center space-x-3",children:t.jsx("button",{onClick:()=>q(!1),className:"md:hidden text-white/80 hover:text-white",children:t.jsx(m,{size:24})})})]}),Z&&t.jsxs("div",{className:"flex flex-col items-center mt-4",children:[t.jsx(n,{to:"/staff/profile",className:"w-24 h-24 rounded-full overflow-hidden border-2 border-white/50 mb-2 bg-gray-200",children:t.jsx("img",{src:E(null==Z?void 0:Z.profile_pic,null==O?void 0:O.staffId,"staff"),alt:"Profile",className:"w-full h-full object-cover",onError:e=>{e.target.src=T(null==O?void 0:O.staffId,"staff")}})}),t.jsxs("h3",{className:"text-white font-semibold text-center text-lg",children:[Z.rank," ",Z.first_name," ",Z.last_name]}),t.jsx("p",{className:"text-white/70 text-sm text-center",children:Z.role})]})]}),t.jsxs("nav",{className:"flex-1 p-3 md:p-4 space-y-1 md:space-y-2 overflow-y-auto text-sm md:text-base",children:[t.jsxs(n,{to:(null==O?void 0:O.isProfileCompleted)?"/staff/home":"#",onClick:e=>{(null==O?void 0:O.isProfileCompleted)||e.preventDefault(),q(!1)},className:c("nav-link space-x-3 transition hover-highlight","/staff/home"===L.pathname?"bg-black/10 text-white":"text-white/80 hover:bg-black/10 hover:text-white",!(null==O?void 0:O.isProfileCompleted)&&"opacity-50 cursor-not-allowed"),children:[t.jsx(f,{size:20}),t.jsx("span",{children:"Home"}),!(null==O?void 0:O.isProfileCompleted)&&t.jsx(x,{size:16,className:"ml-auto"})]}),t.jsxs(n,{to:(null==O?void 0:O.isProfileCompleted)?"/staff/dashboard":"#",onClick:e=>{(null==O?void 0:O.isProfileCompleted)||e.preventDefault(),q(!1)},className:c("nav-link space-x-3 transition hover-highlight","/staff/dashboard"===L.pathname?"bg-black/10 text-white":"text-white/80 hover:bg-black/10 hover:text-white",!(null==O?void 0:O.isProfileCompleted)&&"opacity-50 cursor-not-allowed"),children:[t.jsx(p,{size:20}),t.jsx("span",{children:"My Portal"}),!(null==O?void 0:O.isProfileCompleted)&&t.jsx(x,{size:16,className:"ml-auto"})]}),le&&t.jsxs(t.Fragment,{children:[t.jsxs(n,{to:(null==O?void 0:O.isProfileCompleted)?"/staff/unit-dashboard":"#",onClick:e=>{(null==O?void 0:O.isProfileCompleted)||e.preventDefault(),q(!1)},className:c("nav-link space-x-3 transition hover-highlight","/staff/unit-dashboard"===L.pathname?"bg-black/10 text-white":"text-white/80 hover:bg-black/10 hover:text-white",!(null==O?void 0:O.isProfileCompleted)&&"opacity-50 cursor-not-allowed"),children:[t.jsx(p,{size:20}),t.jsx("span",{children:"Unit Dashboard"}),!(null==O?void 0:O.isProfileCompleted)&&t.jsx(x,{size:16,className:"ml-auto"})]}),t.jsxs(n,{to:(null==O?void 0:O.isProfileCompleted)?"/staff/data-analysis":"#",onClick:e=>{(null==O?void 0:O.isProfileCompleted)||e.preventDefault(),q(!1)},className:c("nav-link space-x-3 transition hover-highlight","/staff/data-analysis"===L.pathname?"bg-black/10 text-white":"text-white/80 hover:bg-black/10 hover:text-white",!(null==O?void 0:O.isProfileCompleted)&&"opacity-50 cursor-not-allowed"),children:[t.jsx(u,{size:20}),t.jsx("span",{children:"Data Analysis"}),!(null==O?void 0:O.isProfileCompleted)&&t.jsx(x,{size:16,className:"ml-auto"})]}),t.jsxs(n,{to:(null==O?void 0:O.isProfileCompleted)?"/staff/activities":"#",onClick:e=>{(null==O?void 0:O.isProfileCompleted)||e.preventDefault(),q(!1)},className:c("nav-link space-x-3 transition hover-highlight","/staff/activities"===L.pathname?"bg-black/10 text-white":"text-white/80 hover:bg-black/10 hover:text-white",!(null==O?void 0:O.isProfileCompleted)&&"opacity-50 cursor-not-allowed"),children:[t.jsx(v,{size:20}),t.jsx("span",{children:"Activities"}),!(null==O?void 0:O.isProfileCompleted)&&t.jsx(x,{size:16,className:"ml-auto"})]}),t.jsxs(n,{to:(null==O?void 0:O.isProfileCompleted)?"/staff/achievements":"#",onClick:e=>{(null==O?void 0:O.isProfileCompleted)||e.preventDefault(),q(!1)},className:c("nav-link space-x-3 transition hover-highlight","/staff/achievements"===L.pathname?"bg-black/10 text-white":"text-white/80 hover:bg-black/10 hover:text-white",!(null==O?void 0:O.isProfileCompleted)&&"opacity-50 cursor-not-allowed"),children:[t.jsx(g,{size:20}),t.jsx("span",{children:"Achievements"}),!(null==O?void 0:O.isProfileCompleted)&&t.jsx(x,{size:16,className:"ml-auto"})]})]}),t.jsxs(n,{to:(null==O?void 0:O.isProfileCompleted)?"/staff/communication":"#",onClick:e=>{(null==O?void 0:O.isProfileCompleted)||e.preventDefault(),q(!1)},className:c("nav-link space-x-3 transition hover-highlight","/staff/communication"===L.pathname?"bg-black/10 text-white":"text-white/80 hover:bg-black/10 hover:text-white",!(null==O?void 0:O.isProfileCompleted)&&"opacity-50 cursor-not-allowed"),children:[t.jsx(b,{size:20}),t.jsx("span",{children:"Communication"}),!(null==O?void 0:O.isProfileCompleted)&&t.jsx(x,{size:16,className:"ml-auto"})]}),t.jsxs(n,{to:"/staff/ask-admin",onClick:()=>q(!1),className:c("nav-link space-x-3 transition hover-highlight","/staff/ask-admin"===L.pathname?"bg-black/10 text-white":"text-white/80 hover:bg-black/10 hover:text-white"),children:[t.jsx(y,{size:20}),t.jsx("span",{children:"Ask Admin"})]}),t.jsxs(n,{to:(null==O?void 0:O.isProfileCompleted)?"/staff/my-qr":"#",onClick:e=>{(null==O?void 0:O.isProfileCompleted)||e.preventDefault(),q(!1)},className:c("nav-link space-x-3 transition hover-highlight","/staff/my-qr"===L.pathname?"bg-black/10 text-white":"text-white/80 hover:bg-black/10 hover:text-white",!(null==O?void 0:O.isProfileCompleted)&&"opacity-50 cursor-not-allowed"),children:[t.jsx(j,{size:20}),t.jsx("span",{children:"My QR Code"}),!(null==O?void 0:O.isProfileCompleted)&&t.jsx(x,{size:16,className:"ml-auto"})]}),t.jsxs(n,{to:(null==O?void 0:O.isProfileCompleted)?"/staff/settings":"#",onClick:e=>{(null==O?void 0:O.isProfileCompleted)||e.preventDefault(),q(!1)},className:c("nav-link space-x-3 transition hover-highlight","/staff/settings"===L.pathname?"bg-black/10 text-white":"text-white/80 hover:bg-black/10 hover:text-white",!(null==O?void 0:O.isProfileCompleted)&&"opacity-50 cursor-not-allowed"),children:[t.jsx(w,{size:20}),t.jsx("span",{children:"Settings"}),!(null==O?void 0:O.isProfileCompleted)&&t.jsx(x,{size:16,className:"ml-auto"})]})]}),t.jsx("div",{className:"mt-auto p-4 border-t border-white/10 bg-black/10 backdrop-blur pb-[var(--sab)] sticky bottom-0",children:t.jsxs("button",{onClick:()=>{q(!1),M(),H("/login")},className:"w-full flex items-center justify-center gap-2 py-3 rounded-md bg-white/10 hover:bg-white/15 text-white hover:opacity-95 transition",type:"button","aria-label":"Logout",children:[t.jsx(k,{size:20}),t.jsx("span",{children:"Logout"})]})})]}),t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden md:ml-64",children:[t.jsxs(D,{position:"top",respectSafeArea:!0,className:"bg-white dark:bg-gray-900 shadow p-4 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("button",{onClick:()=>q(!R),className:"text-[var(--primary-color)] focus:outline-none md:hidden mr-4 touch-target p-2",style:{minHeight:"48px",minWidth:"48px"},children:t.jsx(C,{size:28})}),t.jsx("span",{className:"font-bold text-gray-900 dark:text-gray-100",children:"Training Staff Portal"})]}),t.jsx("div",{className:"flex items-center space-x-4",children:t.jsx(I,{type:"Messages",icon:N,count:G,notifications:[...K,...U].sort((e,t)=>new Date(t.created_at)-new Date(e.created_at)),navigateToMessage:"/staff/ask-admin",navigateToBroadcast:"/staff/broadcasts",onMarkRead:async e=>{try{await d.delete(`/api/messages/${e}`).catch(()=>{}),await d.delete(`/api/notifications/${e}`).catch(()=>{}),W(t=>t.filter(t=>t.id!==e)),Q(t=>t.filter(t=>t.id!==e))}catch(t){}},onClear:async()=>{try{await Promise.all(U.map(e=>d.delete(`/api/messages/${e.id}`).catch(()=>{}))),await d.delete("/api/staff/notifications/delete-all").catch(()=>{}),W([]),Q([])}catch(e){}}})})]}),t.jsx(A,{className:"flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-950 p-4 md:p-8 readable-text text-balance",enableKeyboardAdjustment:!0,enableScrollAdjustment:!0,children:t.jsx(r,{})})]}),te&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60",children:t.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-xl max-w-md w-full mx-4 p-6",children:[t.jsx("h2",{className:"text-lg font-bold text-gray-800 dark:text-gray-100 mb-2",children:"Allow Location Access"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-3",children:"To display local weather advisories, the app requests your location. You may decline; we will use approximate location or defaults."}),t.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mb-4",children:"You can change location permission anytime in your browser or device settings."}),t.jsxs("div",{className:"flex justify-end space-x-3",children:[t.jsx("button",{type:"button",onClick:()=>{try{localStorage.setItem("rgms_permissions_seen","true")}catch{}ae(!1)},className:"px-4 py-2 text-sm rounded border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 hover-highlight",children:"Not now"}),t.jsx("button",{type:"button",onClick:()=>{try{navigator.geolocation&&navigator.geolocation.getCurrentPosition(()=>{},()=>{},{enableHighAccuracy:!0,timeout:1e4})}catch{}try{localStorage.setItem("rgms_permissions_seen","true")}catch{}ae(!1)},className:"px-4 py-2 text-sm rounded bg-[var(--primary-color)] text-white hover:opacity-90 hover-highlight",children:"Allow permissions"})]})]})})]})})})})})};export{O as default};
