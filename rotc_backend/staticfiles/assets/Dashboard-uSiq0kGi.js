import{u as e,j as t,c as a,g as s}from"./index-CS3KqmWJ.js";import{u as r,r as d}from"./vendor-react-BJYbxeCs.js";import{a as l}from"./vendor-utils-qHW_S61q.js";import"./MobileFormLayout-CMymzK14.js";import{av as i,t as n,K as c}from"./vendor-ui-Cf-65S3f.js";import"./useResponsive-XC39aU2L.js";const o=()=>{r();const{user:o}=e?e():{user:null},[m,x]=d.useState(null),[h,p]=d.useState([]),[b,g]=d.useState([]),[u,y]=d.useState(!0),[j,f]=d.useState(!1),[N,w]=d.useState({type:"all",start:"",end:"",page:1,pageSize:10}),[v,_]=d.useState({order:"asc"}),S=async(e=v)=>{const t={};t.order=e.order||"asc";let s={items:[],total:0,page:1,pageSize:0};try{const e=(await l.get("/api/attendance/my-history",{params:t})).data;s=Array.isArray(e)?{items:e,total:e.length,page:1,pageSize:e.length||15}:e||s}catch{s={items:[],total:0,page:1,pageSize:0}}if(!s.items||0===s.items.length)try{const e=await l.get("/api/attendance/days"),t=(Array.isArray(e.data)?e.data:[]).map(e=>({id:null,date:e.date,title:e.title,status:"absent",remarks:null,time_in:null,time_out:null})).sort((e,t)=>new Date(e.date)-new Date(t.date));s={items:t,total:t.length,page:1,pageSize:t.length}}catch{}g(s),await a("dashboard","cadet_attendance",{data:s,timestamp:Date.now()})},D=async()=>{const e=await l.get(`/api/cadet/my-merit-logs?t=${Date.now()}`).catch(()=>({data:[]})),t=Array.isArray(e.data)?e.data:[];p(t),await a("dashboard","cadet_logs",{data:t,timestamp:Date.now()})};return d.useEffect(()=>{(async()=>{if(o&&"cadet"===o.role)try{let t=!1;try{const e=await l.get(`/api/cadet/my-grades?t=${Date.now()}`);x(e.data),await a("dashboard","cadet_grades",{data:e.data,timestamp:Date.now()})}catch(e){const a=await s("dashboard","cadet_grades");a&&(x(a.data),t=!0)}const r=await s("dashboard","cadet_logs");if(r){const e=Array.isArray(r.data)?r.data:[];p(e),t=!0}const d=await s("dashboard","cadet_attendance");if(d){const e=d.data&&d.data.items?d.data:Array.isArray(d.data)?{items:d.data,total:d.data.length,page:1,pageSize:d.data.length||15}:d.data;g(e),t=!0}t&&y(!1);const i=Date.now(),n=3e5,c=[];(!r||i-r.timestamp>n||r&&(!r.data||!Array.isArray(r.data)||0===r.data.length))&&c.push(D().catch(e=>{}));(!d||i-d.timestamp>n||d&&(!d.data||(Array.isArray(d.data)?0===d.data.length:0===(d.data.items||[]).length)))&&c.push(S(v).catch(e=>{})),await Promise.allSettled(c)}catch(t){}finally{y(!1)}else y(!1)})()},[o]),d.useEffect(()=>{if(!o||"cadet"!==o.role)return;const e=async()=>{try{const e=await l.get(`/api/cadet/my-grades?t=${Date.now()}`);x(e.data),await a("dashboard","cadet_grades",{data:e.data,timestamp:Date.now()})}catch{}},t=()=>{"visible"===document.visibilityState&&e()};return window.addEventListener("focus",e),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("focus",e),document.removeEventListener("visibilitychange",t)}},[o]),d.useEffect(()=>{if(!o||"cadet"!==o.role)return;let e;const t=()=>{try{e=new EventSource("/api/attendance/events"),e.onopen=()=>f(!0),e.onmessage=async e=>{try{const t=JSON.parse(e.data||"{}");if("grade_updated"===t.type){const e=await l.get(`/api/cadet/my-grades?t=${Date.now()}`);x(e.data),await a("dashboard","cadet_grades",{data:e.data,timestamp:Date.now()});try{await D()}catch{}try{await S(v)}catch{}}else if("attendance_updated"===t.type)try{await S(v)}catch{}}catch{}},e.onerror=()=>{f(!1),e&&e.close(),setTimeout(t,3e3)}}catch{}};return t(),()=>{try{e&&e.close()}catch{}}},[o]),u?t.jsx("div",{className:"text-center p-10",children:"Loading..."}):t.jsxs("div",{className:"space-y-8",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"My Portal"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:"px-3 py-1 rounded text-xs font-bold "+(j?"bg-green-100 text-green-800":"bg-gray-100 text-gray-700"),children:j?"Live Sync On":"Offline"}),t.jsx("button",{onClick:async()=>{try{const e=Date.now(),t=await l.get(`/api/cadet/my-grades?t=${Date.now()}`);x(t.data),await a("dashboard","cadet_grades",{data:t.data,timestamp:e}),await D(),await S({...v,page:1})}catch{}},className:"px-3 py-1 rounded bg-[var(--primary-color)] text-white text-sm hover:opacity-90",children:"Refresh"})]})]}),t.jsx("div",{className:"space-y-6",children:(()=>{const e=m||{attendanceScore:0,attendance_present:0,totalTrainingDays:0,aptitudeScore:0,merit_points:0,demerit_points:0,subjectScore:0,prelim_score:0,midterm_score:0,final_score:0,finalGrade:0,transmutedGrade:"5.00",remarks:"No Data"};return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"bg-white rounded shadow p-6",children:[t.jsx("h2",{className:"text-xl font-bold mb-4 border-b pb-2",children:"Final Assessment"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t.jsxs("div",{className:"bg-gray-100 p-6 rounded text-center border",children:[t.jsx("h3",{className:"text-sm text-gray-800 font-semibold uppercase tracking-wider",children:"Final Grade (Numerical)"}),t.jsx("div",{className:"text-5xl font-bold mt-3 text-gray-800",children:Number(e.finalGrade).toFixed(2)})]}),t.jsxs("div",{className:"p-6 rounded text-center shadow-md transform transition-transform "+("5.00"===e.transmutedGrade||["DO","INC","T"].includes(e.transmutedGrade)?"bg-red-600 text-white":"bg-green-600 text-white"),children:[t.jsx("h3",{className:"text-sm font-semibold uppercase tracking-wider opacity-90",children:"Transmuted Grade"}),t.jsx("div",{className:"text-6xl font-extrabold mt-2",children:e.transmutedGrade}),t.jsx("div",{className:"text-xl font-medium mt-2 uppercase tracking-wide border-t border-white/30 pt-2 inline-block px-4",children:e.remarks})]})]})]}),t.jsxs("div",{className:"bg-white rounded shadow p-6",children:[t.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b pb-2",children:[t.jsxs("h2",{className:"text-xl font-bold text-purple-800 flex items-center",children:[t.jsx(i,{className:"mr-2",size:20}),"Subject Proficiency (40%)"]}),t.jsx("div",{className:"mt-2 md:mt-0",children:t.jsxs("span",{className:"text-2xl font-bold text-purple-900",children:[Number(e.subjectScore).toFixed(2)," pts"]})})]}),t.jsx("div",{className:"overflow-x-auto max-h-[300px] overflow-y-auto border rounded",children:t.jsxs("table",{className:"w-full text-left border-collapse",children:[t.jsx("thead",{className:"sticky top-0 bg-gray-100 shadow-sm z-10",children:t.jsxs("tr",{className:"border-b",children:[t.jsx("th",{className:"p-3 font-semibold text-gray-600",children:"Prelim"}),t.jsx("th",{className:"p-3 font-semibold text-gray-600",children:"Midterm"}),t.jsx("th",{className:"p-3 font-semibold text-gray-600",children:"Final"})]})}),t.jsx("tbody",{children:t.jsxs("tr",{children:[t.jsx("td",{className:"p-3 font-bold",children:e.prelim_score}),t.jsx("td",{className:"p-3 font-bold",children:e.midterm_score}),t.jsx("td",{className:"p-3 font-bold",children:e.final_score})]})})]})})]}),t.jsxs("div",{className:"bg-white rounded shadow p-6",children:[t.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b pb-2",children:[t.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center",children:[t.jsx(n,{className:"mr-2",size:20}),"Attendance History (30%)"]}),t.jsxs("div",{className:"mt-2 md:mt-0 text-right",children:[t.jsxs("span",{className:"text-2xl font-bold text-blue-900",children:[Number(e.attendanceScore).toFixed(2)," pts"]}),t.jsxs("span",{className:"text-sm text-gray-500 ml-2",children:["(",e.attendance_present," / ",e.totalTrainingDays," days)"]}),t.jsxs("span",{className:"text-xs text-gray-500 ml-2 block md:inline",children:["Present: ",e.attendance_present," â€¢ Absent: ",Math.max(0,(e.totalTrainingDays||0)-(e.attendance_present||0))]})]})]}),t.jsx("div",{className:"overflow-x-auto max-h-[300px] overflow-y-auto border rounded",children:t.jsxs("table",{className:"w-full text-left border-collapse",children:[t.jsx("thead",{className:"sticky top-0 bg-gray-100 shadow-sm z-10",children:t.jsxs("tr",{className:"border-b",children:[t.jsx("th",{className:"p-3 font-semibold text-gray-600",children:"Date"}),t.jsx("th",{className:"p-3 font-semibold text-gray-600",children:"Status"})]})}),t.jsx("tbody",{children:(()=>{const e=b&&b.items?b:{items:Array.isArray(b)?b:[],total:(null==b?void 0:b.total)||0,pageSize:(null==b?void 0:b.pageSize)||(null==b?void 0:b.total)||0};return e.items.length>0?e.items.map(e=>t.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[t.jsx("td",{className:"p-3 text-sm",children:new Date(e.date).toLocaleDateString()}),t.jsx("td",{className:"p-3",children:(()=>{const a=(e.status||"unmarked").toLowerCase(),s="present"===a?"bg-green-100 text-green-800":"late"===a?"bg-yellow-100 text-yellow-800":"excused"===a?"bg-blue-100 text-blue-800":"absent"===a?"bg-red-100 text-red-800":"bg-gray-100 text-gray-700",r=a.charAt(0).toUpperCase()+a.slice(1);return t.jsx("span",{className:`px-2 py-1 rounded text-xs font-bold uppercase ${s}`,children:r})})()})]},e.id||`${e.date}-${e.title}`)):t.jsx("tr",{children:t.jsx("td",{colSpan:"6",className:"p-4 text-center text-gray-500",children:"No attendance records found."})})})()})]})})]}),t.jsxs("div",{className:"bg-white rounded shadow p-6",children:[t.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b pb-2",children:[t.jsxs("h2",{className:"text-xl font-bold text-green-800 flex items-center",children:[t.jsx(c,{className:"mr-2",size:20}),"Merit & Demerit Records (30%)"]}),t.jsxs("div",{className:"mt-2 md:mt-0 text-right",children:[t.jsxs("span",{className:"text-2xl font-bold text-green-900",children:[Number(e.aptitudeScore).toFixed(2)," pts"]}),t.jsxs("span",{className:"text-sm text-gray-500 ml-2 block md:inline",children:["(Merits: ",e.merit_points," | Demerits: ",e.demerit_points,")"]})]})]}),(()=>{const a=100+(e.merit_points||0)-(e.demerit_points||0),s=Math.min(100,Math.max(0,a)),r=100===s&&a>=100,d=Math.max(0,a-100),l=e.lifetime_merit_points||e.merit_points||0;return t.jsxs("div",{className:"mb-4 space-y-3",children:[t.jsx("div",{className:"bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg border border-green-200",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Current Aptitude Score"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-3xl font-bold text-green-700",children:s}),t.jsx("span",{className:"text-lg text-gray-500",children:"/ 100"}),r&&t.jsx("span",{className:"ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-bold rounded-full border border-yellow-300",children:"AT CEILING"})]}),t.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Formula: 100 + Merits (",e.merit_points,") - Demerits (",e.demerit_points,") = ",a," â†’ ",s]})]}),t.jsx("div",{className:"text-right",children:t.jsx("div",{className:"w-24 h-24 rounded-full border-8 border-green-500 flex items-center justify-center bg-white shadow-lg",children:t.jsx("span",{className:"text-2xl font-bold text-green-700",children:s})})})]})}),t.jsx("div",{className:"bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border border-purple-200",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("p",{className:"text-sm font-semibold text-gray-700 mb-1 flex items-center gap-2",children:[t.jsx("span",{className:"text-purple-600",children:"ðŸ†"}),"Lifetime Merit Achievement"]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-3xl font-bold text-purple-700",children:l}),t.jsx("span",{className:"text-sm text-gray-600",children:"total merits earned"})]}),t.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"This tracks all merit points you've earned throughout your ROTC career"})]}),l>=100&&t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-4xl mb-1",children:"ðŸŒŸ"}),t.jsx("p",{className:"text-xs font-bold text-purple-700",children:"Century Club"})]})]})}),d>0&&t.jsx("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded",children:t.jsxs("div",{className:"flex items-start",children:[t.jsx("div",{className:"flex-shrink-0",children:t.jsx(c,{className:"h-5 w-5 text-yellow-400"})}),t.jsxs("div",{className:"ml-3",children:[t.jsx("h3",{className:"text-sm font-medium text-yellow-800",children:"Merit Points at Ceiling"}),t.jsxs("div",{className:"mt-2 text-sm text-yellow-700",children:[t.jsxs("p",{children:["You've earned ",t.jsxs("strong",{children:[d," extra merit points"]})," beyond the 100-point ceiling. These points are tracked in your lifetime total but don't increase your current aptitude score."]}),t.jsxs("p",{className:"mt-1 text-xs",children:["ðŸ’¡ Your lifetime achievement of ",t.jsxs("strong",{children:[l," merits"]})," is still recognized for awards and honors!"]})]})]})]})})]})})(),t.jsx("div",{className:"overflow-x-auto max-h-[300px] overflow-y-auto border rounded",children:t.jsxs("table",{className:"w-full text-left border-collapse",children:[t.jsx("thead",{className:"sticky top-0 bg-gray-100 shadow-sm z-10",children:t.jsxs("tr",{className:"border-b",children:[t.jsx("th",{className:"p-3 font-semibold text-gray-600",children:"Date"}),t.jsx("th",{className:"p-3 font-semibold text-gray-600",children:"Type"}),t.jsx("th",{className:"p-3 font-semibold text-gray-600",children:"Points"}),t.jsx("th",{className:"p-3 font-semibold text-gray-600",children:"Reason"}),t.jsx("th",{className:"p-3 font-semibold text-gray-600",children:"Issued By"})]})}),t.jsx("tbody",{children:Array.isArray(h)&&h.length>0?h.map(e=>t.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[t.jsx("td",{className:"p-3 text-sm",children:new Date(e.date_recorded).toLocaleDateString()}),t.jsx("td",{className:"p-3",children:t.jsx("span",{className:"px-2 py-1 rounded text-xs font-bold uppercase "+("merit"===e.type?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:e.type})}),t.jsx("td",{className:"p-3 font-bold",children:e.points}),t.jsx("td",{className:"p-3 text-sm text-gray-600",children:e.reason||"-"}),t.jsx("td",{className:"p-3 text-sm text-gray-600",children:e.issued_by_name||"-"})]},e.id||`${e.type}-${e.points}-${e.date_recorded}`)):t.jsx("tr",{children:t.jsx("td",{colSpan:"5",className:"p-4 text-center text-gray-500",children:"No records found."})})})]})})]})]})})()}),!1,!1]})};export{o as default};
